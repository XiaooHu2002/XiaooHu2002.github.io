

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>
<head>
  <script async src="https://us.umami.is/script.js" data-website-id="83039d8f-bd3d-4637-bcfa-22c3a2fc0ac1"></script>

<meta name="generator" content="Hexo 6.3.0"></head>


<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#9ce8f452">
  <meta name="author" content="严千屹">
  <meta name="keywords" content="">
  
    <meta name="description" content="NFS+postgresql+Redis">
<meta property="og:type" content="article">
<meta property="og:title" content="Harbor共享存储高可用">
<meta property="og:url" content="https://blog.qianyios.top/posts/40301/index.html">
<meta property="og:site_name" content="严千屹博客">
<meta property="og:description" content="NFS+postgresql+Redis">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.qianyios.top/img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/Snipaste_2024-04-30_18-31-45.png">
<meta property="article:published_time" content="2024-04-30T18:52:40.000Z">
<meta property="article:modified_time" content="2024-10-09T08:49:48.517Z">
<meta property="article:author" content="严千屹">
<meta property="article:tag" content="OpenEuler">
<meta property="article:tag" content="Harbor">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog.qianyios.top/img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/Snipaste_2024-04-30_18-31-45.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>Harbor共享存储高可用 - 严千屹博客</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/mycss.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"blog.qianyios.top","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":true,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  <meta name="referrer" content="no-referrer"/>

  
</head>

<link rel="stylesheet" href="https://portb.kbai.cc/hexo&kbai/mousezhizhen.css"/>
<canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 9999; pointer-events: none;" ></canvas>
<script src="https://cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script>
<script src="https://script-1256884783.file.myqcloud.com/cursor/explosion.min.js"></script>
<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>严 千 屹</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/null') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Harbor共享存储高可用"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-04-30 18:52" pubdate>
          2024年4月30日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          30k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          253 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Harbor共享存储高可用</h1>
            
            
              <div class="markdown-body">
                
                <meta name="referrer" content="no-referrer"/>

<h1 id="Harbor共享存储高可用"><a href="#Harbor共享存储高可用" class="headerlink" title="Harbor共享存储高可用"></a>Harbor共享存储高可用</h1><h2 id="主机拓扑"><a href="#主机拓扑" class="headerlink" title="主机拓扑"></a>主机拓扑</h2><table>
<thead>
<tr>
<th>角色</th>
<th>主机名</th>
<th>ip</th>
<th>系统</th>
<th>资源最低要求</th>
</tr>
</thead>
<tbody><tr>
<td>Harbor1<br />nginx<br />Keepalived1</td>
<td>harbor1</td>
<td>192.168.48.106</td>
<td>OpenEuler22.03LTS</td>
<td>CPU：4核 <br />内存：8G <br />硬盘：40G</td>
</tr>
<tr>
<td>Harbor2<br />nginx<br />Keepalived2</td>
<td>harbor2</td>
<td>192.168.48.107</td>
<td>OpenEuler22.03LTS</td>
<td>CPU：4核 <br />内存：8G <br />硬盘：40G</td>
</tr>
<tr>
<td>postgresql<br />Redis<br />NFS共享</td>
<td>zujian</td>
<td>192.168.48.108</td>
<td>OpenEuler22.03LTS</td>
<td>CPU：4核 <br />内存：8G <br />硬盘：40G</td>
</tr>
<tr>
<td>高可用ip</td>
<td>192.168.48.100</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p><code>系统架构图</code></p>
<p><img src="/../img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/20f63cd16f752c0b669b3b7271045ae1697559838-1728463576637-3.png" srcset="/img/loading.gif" lazyload alt="image-20240430185108978"></p>
<h2 id="基本配置"><a href="#基本配置" class="headerlink" title="基本配置"></a>基本配置</h2><p>操作节点：[harbor1，harbour2，zujian]</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">vi</span> jichu_init.<span class="hljs-keyword">sh</span><br></code></pre></td></tr></table></figure>

<p>将以下脚本内容添加进去</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-variable">$#</span> -eq 2 ];then<br>  echo <span class="hljs-string">&quot;设置主机名为：<span class="hljs-variable">$1</span>&quot;</span><br>  echo <span class="hljs-string">&quot;ens160设置IP地址为：192.168.48.<span class="hljs-variable">$2</span>&quot;</span><br><span class="hljs-keyword">else</span><br>  echo  <span class="hljs-string">&quot;使用方法：sh <span class="hljs-variable">$0</span> 主机名 主机位&quot;</span><br>  exit 2<br>fi<br><br>echo <span class="hljs-string">&quot;--------------------------------------&quot;</span><br>echo <span class="hljs-string">&quot;1.正在设置主机名：<span class="hljs-variable">$1</span>&quot;</span><br>hostnamectl set-hostname <span class="hljs-variable">$1</span><br><br>echo <span class="hljs-string">&quot;2.正在关闭firewalld、dnsmasq、selinux&quot;</span><br>systemctl <span class="hljs-built_in">disable</span> firewalld &amp;&gt; /dev/<span class="hljs-literal">null</span><br>systemctl <span class="hljs-built_in">disable</span> dnsmasq &amp;&gt; /dev/<span class="hljs-literal">null</span><br>systemctl stop firewalld<br>systemctl stop dnsmasq<br>sed -i <span class="hljs-string">&quot;s#SELINUX=enforcing#SELINUX=disabled#g&quot;</span> /etc/selinux<span class="hljs-built_in">/config</span><br><span class="hljs-built_in"></span>setenforce 0<br><br><br>echo <span class="hljs-string">&quot;3.正在设置ens160：192.168.48.<span class="hljs-variable">$2</span>&quot;</span><br>cat &gt; /etc/sysconfig/network-scripts/ifcfg-ens160 &lt;&lt;EOF<br><span class="hljs-attribute">TYPE</span>=Ethernet<br><span class="hljs-attribute">PROXY_METHOD</span>=none<br><span class="hljs-attribute">BROWSER_ONLY</span>=<span class="hljs-literal">no</span><br><span class="hljs-attribute">BOOTPROTO</span>=static<br><span class="hljs-attribute">DEFROUTE</span>=<span class="hljs-literal">yes</span><br><span class="hljs-attribute">IPV4_FAILURE_FATAL</span>=<span class="hljs-literal">no</span><br><span class="hljs-attribute">IPV6INIT</span>=<span class="hljs-literal">yes</span><br><span class="hljs-attribute">IPV6_AUTOCONF</span>=<span class="hljs-literal">yes</span><br><span class="hljs-attribute">IPV6_DEFROUTE</span>=<span class="hljs-literal">yes</span><br><span class="hljs-attribute">IPV6_FAILURE_FATAL</span>=<span class="hljs-literal">no</span><br><span class="hljs-attribute">NAME</span>=ens160<br><span class="hljs-attribute">UUID</span>=53b402ff-5865-47dd-a853-7afcd6521738<br><span class="hljs-attribute">DEVICE</span>=ens160<br><span class="hljs-attribute">ONBOOT</span>=<span class="hljs-literal">yes</span><br><span class="hljs-attribute">IPADDR</span>=192.168.48.$2<br><span class="hljs-attribute">GATEWAY</span>=192.168.48.2<br><span class="hljs-attribute">PREFIX</span>=24<br><span class="hljs-attribute">DNS1</span>=192.168.48.2<br><span class="hljs-attribute">DNS2</span>=114.114.114.114<br><br>nmcli c reload<br>nmcli c up ens 160<br><br>echo <span class="hljs-string">&quot;4.优化ssh&quot;</span><br>sed -i <span class="hljs-string">&quot;s#\#UseDNS yes#UseDNS no#g&quot;</span> /etc/ssh/sshd_config<br>sed -i <span class="hljs-string">&quot;s#GSSAPIAuthentication yes#GSSAPIAuthentication no#g&quot;</span> /etc/ssh/sshd_config<br>systemctl restart sshd<br><br>echo <span class="hljs-string">&quot;5.更改欧拉源为华为云源，速度快一点&quot;</span><br>sed -i <span class="hljs-string">&#x27;s/\$basearch/x86_64/g&#x27;</span> /etc/yum.repos.d/openEuler.repo<br>sed -i <span class="hljs-string">&#x27;s/repo.openeuler.org/mirrors.huaweicloud.com\/openeuler/g&#x27;</span> /etc/yum.repos.d/openEuler.repo<br><br><br>echo <span class="hljs-string">&quot;6.更新yum源软件包缓存&quot;</span><br>yum clean all &amp;&amp; yum makecache<br>dnf update -y<br><br>echo <span class="hljs-string">&quot;7.修改history格式及记录数&quot;</span><br>sed -i <span class="hljs-string">&quot;s#HISTSIZE=1000##g&quot;</span> /etc<span class="hljs-built_in">/profile</span><br><span class="hljs-built_in"></span>cat &gt;&gt; /etc<span class="hljs-built_in">/profile </span>&lt;&lt;EOF<br>shopt -s histappend<br><span class="hljs-attribute">USER_IP</span>=`who -u am i 2&gt;/dev/<span class="hljs-literal">null</span>| awk <span class="hljs-string">&#x27;&#123;print $NF&#125;&#x27;</span>|sed -e <span class="hljs-string">&#x27;s/[()]//g&#x27;</span>`<br><span class="hljs-built_in">export</span> <span class="hljs-attribute">HISTFILE</span>=~/.commandline_warrior<br><span class="hljs-built_in">export</span> <span class="hljs-attribute">HISTTIMEFORMAT</span>=<span class="hljs-string">&quot;%Y-%m-%d %H:%M:%S  `whoami`@<span class="hljs-variable">$&#123;USER_IP&#125;</span>: &quot;</span><br><span class="hljs-built_in">export</span> <span class="hljs-attribute">HISTSIZE</span>=200000<br><span class="hljs-built_in">export</span> <span class="hljs-attribute">HISTFILESIZE</span>=1000000<br><span class="hljs-built_in">export</span> <span class="hljs-attribute">PROMPT_COMMAND</span>=<span class="hljs-string">&quot;history -a&quot;</span><br>EOF<br>source /etc<span class="hljs-built_in">/profile</span><br><span class="hljs-built_in"></span><br><br>echo <span class="hljs-string">&quot;8.添加hosts解析&quot;</span><br>cat &gt; /etc/hosts &lt;&lt;EOF<br>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4<br>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6<br>192.168.48.106 harbor1<br>192.168.48.107 harbor2<br>192.168.48.108 zujian<br>EOF<br><br><br>echo <span class="hljs-string">&quot;10.安装chrony服务，并同步时间&quot;</span><br>dnf install chrony -y<br>systemctl start chronyd<br>systemctl <span class="hljs-built_in">enable</span> chronyd<br>chronyc sources<br>chronyc sources<br><br>echo <span class="hljs-string">&quot;11、安装依赖包&quot;</span><br>dnf install -y cmake gcc gcc-c++ perl readline readline-devel openssl openssl-devel zlib zlib-devel ncurses-devel readline readline-devel zlib zlib-devel<br><br>reboot<br></code></pre></td></tr></table></figure>



<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">执行脚本命令格式：<span class="hljs-keyword">sh </span><span class="hljs-keyword">jichu_init.sh </span>主机名 主机位<br>[harbor1] <span class="hljs-keyword">sh </span><span class="hljs-keyword">jichu_init.sh </span>harbor1 <span class="hljs-number">106</span><br><br>[harbor2] <span class="hljs-keyword">sh </span><span class="hljs-keyword">jichu_init.sh </span>harbor2 <span class="hljs-number">107</span><br><br>[zujian] <span class="hljs-keyword">sh </span><span class="hljs-keyword">jichu_init.sh </span>zujian <span class="hljs-number">108</span><br><br></code></pre></td></tr></table></figure>

<p>配置ssh免密</p>
<p>操作节点：[harbor1，harbour2，zujian]</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">dnf install -y sshpass <br><span class="hljs-built_in">cat</span> &gt; sshmianmi.sh &lt;&lt; <span class="hljs-string">&quot;EOF&quot;</span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment"># 目标主机列表</span><br>hosts=(<span class="hljs-string">&quot;harbor1&quot;</span> <span class="hljs-string">&quot;harbor2&quot;</span> <span class="hljs-string">&quot;zujian&quot;</span>)<br><span class="hljs-comment"># 密码</span><br>password=<span class="hljs-string">&quot;Lj201840.&quot;</span><br><span class="hljs-comment"># 生成 SSH 密钥对</span><br>ssh-keygen -t rsa -N <span class="hljs-string">&quot;&quot;</span> -f ~/.ssh/id_rsa<br><br><span class="hljs-comment"># 循环遍历目标主机</span><br><span class="hljs-keyword">for</span> host <span class="hljs-keyword">in</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;hosts[@]&#125;</span>&quot;</span><br><span class="hljs-keyword">do</span><br>    <span class="hljs-comment"># 复制公钥到目标主机</span><br>    sshpass -p <span class="hljs-string">&quot;<span class="hljs-variable">$password</span>&quot;</span> ssh-copy-id -o StrictHostKeyChecking=no <span class="hljs-string">&quot;<span class="hljs-variable">$host</span>&quot;</span><br>    <br>    <span class="hljs-comment"># 验证免密登录</span><br>    sshpass -p <span class="hljs-string">&quot;<span class="hljs-variable">$password</span>&quot;</span> ssh -o StrictHostKeyChecking=no <span class="hljs-string">&quot;<span class="hljs-variable">$host</span>&quot;</span> <span class="hljs-string">&quot;echo &#x27;免密登录成功&#x27;&quot;</span><br><span class="hljs-keyword">done</span><br>EOF<br><br>sh sshmianmi.sh<br></code></pre></td></tr></table></figure>

<h2 id="安装高可用组件"><a href="#安装高可用组件" class="headerlink" title="安装高可用组件"></a>安装高可用组件</h2><p>操作节点:[harbor1，harbour2]</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">dnf <span class="hljs-keyword">install</span> -y keepalived nginx<br></code></pre></td></tr></table></figure>

<h3 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h3><p>操作节点:[harbor1，harbour2]</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">cat</span> &gt; /etc/nginx/nginx.conf &lt;&lt;<span class="hljs-string">&quot;EOF&quot;</span><br>user nginx;<br><span class="hljs-attribute">worker_processes</span> auto;<br><span class="hljs-attribute">error_log</span> /var/log/nginx/<span class="hljs-literal">error</span>.log <span class="hljs-literal">notice</span>;<br><span class="hljs-attribute">pid</span> /run/nginx.pid;<br><span class="hljs-attribute">include</span> /usr/share/nginx/modules/<span class="hljs-regexp">*.conf</span>;<br><span class="hljs-section">events</span> &#123;<br>    <span class="hljs-attribute">worker_connections</span> <span class="hljs-number">1024</span>;<br>&#125;<br><span class="hljs-section">stream</span> &#123;<br>    <span class="hljs-attribute">log_format</span>  main  <span class="hljs-string">&#x27;<span class="hljs-variable">$remote_addr</span> <span class="hljs-variable">$upstream_addr</span> - [<span class="hljs-variable">$time_local</span>] <span class="hljs-variable">$status</span> <span class="hljs-variable">$upstream_bytes_sent</span>&#x27;</span>;<br>    <span class="hljs-attribute">access_log</span>  /var/log/nginx/harbor-access.log  main;<br>    <span class="hljs-section">upstream</span> harbor&#123;<br>       <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.48.106:8081</span>;   <span class="hljs-comment">#harbor1</span><br>       <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.48.107:8081</span>;   <span class="hljs-comment">#harbor2</span><br>    &#125;<br>    <span class="hljs-section">server</span> &#123;<br>       <span class="hljs-attribute">listen</span>  <span class="hljs-number">80</span>;<br>       <span class="hljs-attribute">proxy_pass</span> harbor;<br>    &#125;<br>&#125;<br><span class="hljs-section">http</span> &#123;<br>    <span class="hljs-attribute">log_format</span>  main  <span class="hljs-string">&#x27;<span class="hljs-variable">$remote_addr</span> - <span class="hljs-variable">$remote_user</span> [<span class="hljs-variable">$time_local</span>] &quot;<span class="hljs-variable">$request</span>&quot; &#x27;</span><br>                      <span class="hljs-string">&#x27;<span class="hljs-variable">$status</span> <span class="hljs-variable">$body_bytes_sent</span> &quot;<span class="hljs-variable">$http_referer</span>&quot; &#x27;</span><br>                      <span class="hljs-string">&#x27;&quot;<span class="hljs-variable">$http_user_agent</span>&quot; &quot;<span class="hljs-variable">$http_x_forwarded_for</span>&quot;&#x27;</span>;<br>    <span class="hljs-attribute">access_log</span>  /var/log/nginx/access.log  main;<br>    <span class="hljs-attribute">sendfile</span>            <span class="hljs-literal">on</span>;<br>    <span class="hljs-attribute">tcp_nopush</span>          <span class="hljs-literal">on</span>;<br>    <span class="hljs-attribute">keepalive_timeout</span>   <span class="hljs-number">65</span>;<br>    <span class="hljs-attribute">types_hash_max_size</span> <span class="hljs-number">4096</span>;<br>    <span class="hljs-attribute">include</span>             /etc/nginx/mime.types;<br>    <span class="hljs-attribute">default_type</span>        application/octet-stream;<br>    <br>    <span class="hljs-attribute">include</span> /etc/nginx/conf.d/<span class="hljs-regexp">*.conf</span>;<br>    <span class="hljs-section">server</span> &#123;<br>        <span class="hljs-attribute">listen</span>       <span class="hljs-number">8888</span> default_server;<br>        <span class="hljs-attribute">server_name</span>  _;<br>        <span class="hljs-section">location</span> / &#123;<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-attribute">EOF</span><br>systemctl enable --now nginx<br>nginx -s reload<br></code></pre></td></tr></table></figure>



<h3 id="安装安装keepalived"><a href="#安装安装keepalived" class="headerlink" title="安装安装keepalived"></a>安装安装keepalived</h3><p>操作节点:[harbor1]</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs fsharp">cat <span class="hljs-operator">&gt;/</span>etc<span class="hljs-operator">/</span>keepalived<span class="hljs-operator">/</span>keepalived.conf <span class="hljs-operator">&lt;&lt;</span> <span class="hljs-string">&quot;EOF&quot;</span><br><span class="hljs-operator">!</span> Configuration File <span class="hljs-keyword">for</span> keepalived<br><br><span class="hljs-keyword">global_defs</span> &#123;<br>   <span class="hljs-keyword">notification_email</span> &#123;<br>     qianyios<span class="hljs-operator">@</span>qq.com<br>   &#125;<br>   router_id harbor1<br>&#125;<br><br>vrrp_instance <span class="hljs-keyword">zh</span> &#123;<br>    state MASTER<br>    <span class="hljs-keyword">interface</span> ens160<br>    mcast_src_ip <span class="hljs-number">192.168</span><span class="hljs-number">.48</span><span class="hljs-number">.106</span><br>    virtual_router_id <span class="hljs-number">107</span><br>    priority <span class="hljs-number">100</span><br>    advert_int <span class="hljs-number">1</span><br>    nopreempt<br>    <span class="hljs-keyword">authentication</span> &#123;<br>        auth_type PASS<br>        auth_pass <span class="hljs-number">1111</span><br>    &#125;<br>    <span class="hljs-keyword">virtual_ipaddress</span> &#123;<br>        <span class="hljs-number">192.168</span><span class="hljs-number">.48</span><span class="hljs-number">.100</span><span class="hljs-operator">/</span><span class="hljs-number">24</span><br>    &#125;<br>    <span class="hljs-keyword">track_script</span> &#123;<br>        chk_nginx<br>    &#125;<br>&#125;<br>vrrp_script <span class="hljs-keyword">chk_nginx</span> &#123;<br>    script <span class="hljs-string">&quot;/etc/keepalived/check_nginx.sh&quot;</span><br>    interval <span class="hljs-number">2</span><br>    weight <span class="hljs-number">-20</span><br>&#125;<br>EOF<br></code></pre></td></tr></table></figure>



<p>操作节点:[harbor2]</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs fsharp">cat <span class="hljs-operator">&gt;/</span>etc<span class="hljs-operator">/</span>keepalived<span class="hljs-operator">/</span>keepalived.conf <span class="hljs-operator">&lt;&lt;</span> <span class="hljs-string">&quot;EOF&quot;</span><br><span class="hljs-operator">!</span> Configuration File <span class="hljs-keyword">for</span> keepalived<br><br><span class="hljs-keyword">global_defs</span> &#123;<br>   <span class="hljs-keyword">notification_email</span> &#123;<br>     qianyios<span class="hljs-operator">@</span>qq.com<br>   &#125;<br>   router_id harbor2<br>&#125;<br><br>vrrp_instance <span class="hljs-keyword">zh</span> &#123;<br>    state BACKUP<br>    <span class="hljs-keyword">interface</span> ens160<br>    mcast_src_ip <span class="hljs-number">192.168</span><span class="hljs-number">.48</span><span class="hljs-number">.107</span><br>    virtual_router_id <span class="hljs-number">107</span><br>    priority <span class="hljs-number">99</span><br>    advert_int <span class="hljs-number">1</span><br>    nopreempt<br>    <span class="hljs-keyword">authentication</span> &#123;<br>        auth_type PASS<br>        auth_pass <span class="hljs-number">1111</span><br>    &#125;<br>    <span class="hljs-keyword">virtual_ipaddress</span> &#123;<br>        <span class="hljs-number">192.168</span><span class="hljs-number">.48</span><span class="hljs-number">.100</span><span class="hljs-operator">/</span><span class="hljs-number">24</span><br>    &#125;<br>    <span class="hljs-keyword">track_script</span> &#123;<br>        chk_nginx<br>    &#125;<br>&#125;<br>vrrp_script <span class="hljs-keyword">chk_nginx</span> &#123;<br>    script <span class="hljs-string">&quot;/etc/keepalived/check_nginx.sh&quot;</span><br>    interval <span class="hljs-number">2</span><br>    weight <span class="hljs-number">-20</span><br>&#125;<br>EOF<br></code></pre></td></tr></table></figure>



<p>配置检查脚本</p>
<p>操作节点:[harbor1，harbour2]</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &gt;/etc/keepalived/check_nginx.sh &lt;&lt;<span class="hljs-string">&quot;EOF&quot;</span><br><span class="hljs-comment">#!/bin/bash</span><br>counter=`ps -C nginx --no-header | <span class="hljs-built_in">wc</span> -l`<br><span class="hljs-keyword">if</span> [ <span class="hljs-variable">$counter</span> -eq 0 ]; <span class="hljs-keyword">then</span><br>    systemctl start nginx<br>    <span class="hljs-built_in">sleep</span> 2<br>    counter=`ps -C nginx --no-header | <span class="hljs-built_in">wc</span> -l`<br>    <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$counter</span> -eq 0 ]; <span class="hljs-keyword">then</span><br>        systemctl stop keepalived<br>    <span class="hljs-keyword">fi</span><br><span class="hljs-keyword">fi</span><br><br>EOF<br></code></pre></td></tr></table></figure>

<p>启动服务</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">systemctl enable <span class="hljs-params">--now</span> nginx keepalived<br>nginx -s <span class="hljs-keyword">reload</span><br></code></pre></td></tr></table></figure>

<p>查看VIP虚拟ip</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs pf">[root@harbor1 ~]<span class="hljs-comment"># ip a</span><br>.............<br><span class="hljs-number">2</span>: ens160: <span class="hljs-variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="hljs-number">1500</span> qdisc mq <span class="hljs-keyword">state</span> UP <span class="hljs-keyword">group</span> <span class="hljs-keyword">default</span> qlen <span class="hljs-number">1000</span><br>    link/ether <span class="hljs-number">00</span>:<span class="hljs-number">0</span>c:<span class="hljs-number">29</span>:af:<span class="hljs-number">76</span>:<span class="hljs-number">8</span>c brd ff:ff:ff:ff:ff:ff<br>    <span class="hljs-keyword">inet</span> <span class="hljs-number">192.168</span>.<span class="hljs-number">48.106</span>/<span class="hljs-number">24</span> brd <span class="hljs-number">192.168</span>.<span class="hljs-number">48.255</span> scope <span class="hljs-keyword">global</span> noprefixroute ens160<br>       valid_lft forever preferred_lft forever<br>    <span class="hljs-keyword">inet</span> <span class="hljs-number">192.168</span>.<span class="hljs-number">48.100</span>/<span class="hljs-number">24</span> scope <span class="hljs-keyword">global</span> secondary ens160   <span class="hljs-comment">###192.168.48.100/24就是刚刚设置的高可用ip</span><br>       valid_lft forever preferred_lft forever<br>    <span class="hljs-keyword">inet6</span> fe80::<span class="hljs-number">20</span>c:<span class="hljs-number">29</span>ff:feaf:<span class="hljs-number">768</span>c/<span class="hljs-number">64</span> scope link noprefixroute<br>       valid_lft forever preferred_lft forever<br><br></code></pre></td></tr></table></figure>

<h2 id="安装postgresql"><a href="#安装postgresql" class="headerlink" title="安装postgresql"></a>安装postgresql</h2><p>操作节点：[zujian]</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment">#创建postgres用户</span><br>useradd postgres<br>passwd postgres<br><span class="hljs-comment">#设置密码123456</span><br><br><br><span class="hljs-comment">#编译安装postgresql</span><br>wget https:<span class="hljs-regexp">//</span>ftp.postgresql.org<span class="hljs-regexp">/pub/</span>source<span class="hljs-regexp">/v16.2/</span>postgresql-<span class="hljs-number">16.2</span>.tar.gz<br>tar zxvf postgresql-<span class="hljs-number">16.2</span>.tar.gz -C <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/bin/</span><br>cd <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/bin/</span>postgresql-<span class="hljs-number">16.2</span>/<br>.<span class="hljs-regexp">/configure --prefix=/u</span>sr<span class="hljs-regexp">/local/</span>postgresql<br>make &amp;&amp; make install<br><br><span class="hljs-comment">#建立数据目录</span><br>mkdir -p <span class="hljs-regexp">/data/</span>postgresql/data<br><span class="hljs-comment">#创建日志目录</span><br>mkdir -p <span class="hljs-regexp">/data/</span>postgresql/log<br><span class="hljs-comment">#创建socket目录</span><br>mkdir -p <span class="hljs-regexp">/data/</span>postgresql/tmp<br><span class="hljs-comment">#授权</span><br>chown -R postgres:postgres <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/postgresql/</span><br>chown -R postgres:postgres <span class="hljs-regexp">/data/</span>postgresql<br><br><span class="hljs-comment">#设置postgres环境</span><br>su - postgres<br>cd<br>cat &lt;&lt; <span class="hljs-string">&quot;EOF&quot;</span> &gt;&gt; ~/.bash_profile<br>PGHOME=<span class="hljs-regexp">/usr/</span>local/postgresql<br>export PGHOME<br>PGDATA=<span class="hljs-regexp">/data/</span>postgresql/data<br>export PGDATA<br>PATH=<span class="hljs-variable">$PATH</span>:<span class="hljs-variable">$HOME</span><span class="hljs-regexp">/bin:$HOME/</span>.local<span class="hljs-regexp">/bin:$PGHOME/</span>bin<br>export PATH<br>EOF<br>source ~/.bash_profile<br>psql -V<br><br><span class="hljs-comment">#初始化数据库</span><br>initdb --username=postgres -D <span class="hljs-regexp">/data/</span>postgresql/data<br><span class="hljs-comment">#会有Success. You can now start the database server using:      #表示初始化成功</span><br><br><br><span class="hljs-comment">#修改初始化的配置文件</span><br>cat &gt; <span class="hljs-regexp">/data/</span>postgresql<span class="hljs-regexp">/data/</span>postgresql.conf &lt;&lt; <span class="hljs-string">&quot;EOF&quot;</span><br>max_connections = <span class="hljs-number">100</span>                   <span class="hljs-comment"># 允许最大连接数</span><br>shared_buffers = <span class="hljs-number">128</span>MB                  <span class="hljs-comment"># 内存大小</span><br>dynamic_shared_memory_type = posix      <span class="hljs-comment"># the default is usually the first option</span><br>max_wal_size = <span class="hljs-number">1</span>GB<br>min_wal_size = <span class="hljs-number">80</span>MB<br>log_timezone = <span class="hljs-string">&#x27;Asia/Shanghai&#x27;</span><br>datestyle = <span class="hljs-string">&#x27;iso, mdy&#x27;</span><br>timezone = <span class="hljs-string">&#x27;Asia/Shanghai&#x27;</span><br>lc_messages = <span class="hljs-string">&#x27;en_US.UTF-8&#x27;</span>             <span class="hljs-comment"># locale for system error message</span><br>lc_monetary = <span class="hljs-string">&#x27;en_US.UTF-8&#x27;</span>             <span class="hljs-comment"># locale for monetary formatting</span><br>lc_numeric = <span class="hljs-string">&#x27;en_US.UTF-8&#x27;</span>              <span class="hljs-comment"># locale for number formatting</span><br>lc_time = <span class="hljs-string">&#x27;en_US.UTF-8&#x27;</span>                 <span class="hljs-comment"># locale for time formatting</span><br>default_text_search_config = <span class="hljs-string">&#x27;pg_catalog.english&#x27;</span><br>listen_addresses = <span class="hljs-string">&#x27;*&#x27;</span> <span class="hljs-comment">#监听所有地址</span><br>data_directory = <span class="hljs-string">&#x27;/data/postgresql/data&#x27;</span>  <span class="hljs-comment"># 数据目录指定</span><br>port = <span class="hljs-number">5432</span><br>unix_socket_directories = <span class="hljs-string">&#x27;/data/postgresql/tmp&#x27;</span><br>unix_socket_group = <span class="hljs-string">&#x27;&#x27;</span><br>unix_socket_permissions = <span class="hljs-number">0777</span><br>logging_collector = on<br>log_directory = <span class="hljs-string">&#x27;/data/postgresql/log&#x27;</span><br>log_rotation_size = <span class="hljs-number">1</span>GB<br>log_timezone = <span class="hljs-string">&#x27;Asia/Shanghai&#x27;</span><br>log_min_duration_statement = <span class="hljs-number">100</span><br><br>EOF<br><span class="hljs-comment">#设置远程连接</span><br>cat &gt;&gt; <span class="hljs-regexp">/data/</span>postgresql<span class="hljs-regexp">/data/</span>pg_hba.conf &lt;&lt; EOF<br>local   all             all                                     trust<br>host    all             all             <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>/<span class="hljs-number">0</span>               password<br>host    all             all             ::<span class="hljs-number">1</span>/<span class="hljs-number">128</span>                 password<br>host    all             postgres             <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span>/<span class="hljs-number">0</span>           trust<br>EOF<br><br><br><span class="hljs-comment">#启动PostgreSQL</span><br>pg_ctl -D <span class="hljs-regexp">/data/</span>postgresql/data -l logfile start<br><br></code></pre></td></tr></table></figure>

<h3 id="进入数据库"><a href="#进入数据库" class="headerlink" title="进入数据库"></a>进入数据库</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs awk">psql -h <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span> -p <span class="hljs-number">5432</span> -U postgres<br><br>postgres=<span class="hljs-comment"># \password</span><br>Enter new password <span class="hljs-keyword">for</span> user <span class="hljs-string">&quot;postgres&quot;</span>:<br>Enter it again:<br><span class="hljs-comment">#输入密码123456</span><br>postgres=<span class="hljs-comment"># exit</span><br><br><span class="hljs-comment">#重新启动</span><br>pg_ctl -D <span class="hljs-regexp">/data/</span>postgresql<span class="hljs-regexp">/data -l /</span>data<span class="hljs-regexp">/postgresql/</span>data/postgresql.log restart<br><br><span class="hljs-comment">#提示一下信息成功（不是命令哈，不要去运行）</span><br>pg_ctl: old server process (PID: <span class="hljs-number">25461</span>) seems to be gone<br>starting server anyway<br>waiting <span class="hljs-keyword">for</span> server to start.... done<br>server started<br><br>psql -h <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span> -p <span class="hljs-number">5432</span> -U postgres<br><span class="hljs-comment">#输入密码123456</span><br><br>CREATE DATABASE registry;<br>CREATE DATABASE notary_signer;<br>CREATE DATABASE notary_servers;<br>\l<br>create user server with password <span class="hljs-string">&#x27;123456&#x27;</span>;<br>create user signer with password <span class="hljs-string">&#x27;123456&#x27;</span>;<br>\du<br>GRANT ALL PRIVILEGES ON DATABASE registry to postgres;   <br>GRANT ALL PRIVILEGES ON DATABASE notary_signer to postgres;   <br>GRANT ALL PRIVILEGES ON DATABASE notary_servers to postgres;   <br><span class="hljs-keyword">exit</span><br></code></pre></td></tr></table></figure>

<p><img src="/../img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/0650027c8cee321759cb3ef62d194432697559838-1728463576637-4.png" srcset="/img/loading.gif" lazyload alt="image-20240421010122073"></p>
<p><img src="/../img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/e3fc601e9f8151aa208d19d590cc2066697559838-1728463576637-5.png" srcset="/img/loading.gif" lazyload alt="image-20240421010045648"></p>
<h3 id="设置启动服务"><a href="#设置启动服务" class="headerlink" title="设置启动服务"></a>设置启动服务</h3><p>操作节点[zujian]</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs gradle">#回到root用户下执行<br>su - root<br>cat &gt;<span class="hljs-regexp">/etc/i</span>nit.d/PG-start.sh&lt;&lt; <span class="hljs-string">&quot;EOF&quot;</span><br>sudo -u postgres <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/postgresql/</span>bin<span class="hljs-regexp">/pg_ctl -D /</span>data<span class="hljs-regexp">/postgresql/</span>data start<br>EOF<br><br>cat &gt;<span class="hljs-regexp">/etc/i</span>nit.d/PG-stop.sh&lt;&lt; <span class="hljs-string">&quot;EOF&quot;</span><br>sudo -u postgres <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/postgresql/</span>bin<span class="hljs-regexp">/pg_ctl -D /</span>data<span class="hljs-regexp">/postgresql/</span>data stop<br>EOF<br><br>cat &gt;<span class="hljs-regexp">/etc/i</span>nit.d/PG-restart.sh&lt;&lt;<span class="hljs-string">&quot;EOF&quot;</span><br>sudo -u postgres <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/postgresql/</span>bin<span class="hljs-regexp">/pg_ctl -D /</span>data<span class="hljs-regexp">/postgresql/</span>data restart<br>EOF<br><br>sudo chmod +x <span class="hljs-regexp">/etc/i</span>nit.d/PG-start.sh<br>sudo chmod +x <span class="hljs-regexp">/etc/i</span>nit.d/PG-stop.sh<br>sudo chmod +x <span class="hljs-regexp">/etc/i</span>nit.d/PG-restart.sh<br><br>cat &gt;<span class="hljs-regexp">/etc/</span>systemd<span class="hljs-regexp">/system/</span>postgresql.service &lt;&lt; <span class="hljs-string">&quot;EOF&quot;</span><br>[Unit]<br><span class="hljs-keyword">Description</span>=postgresql Service<br><br>[Service]<br>Type=oneshot<br>user=root<br>RemainAfterExit=<span class="hljs-keyword">true</span><br>ExecStart=<span class="hljs-regexp">/usr/</span>bin<span class="hljs-regexp">/sudo /</span>etc<span class="hljs-regexp">/init.d/</span>PG-start.sh<br>ExecStop=<span class="hljs-regexp">/usr/</span>bin<span class="hljs-regexp">/sudo /</span>etc<span class="hljs-regexp">/init.d/</span>PG-stop.sh<br>ExecRestart=<span class="hljs-regexp">/usr/</span>bin<span class="hljs-regexp">/sudo /</span>etc<span class="hljs-regexp">/init.d/</span>PG-restart.sh<br><br>[Install]<br>WantedBy=multi-user.target<br>EOF<br>systemctl daemon-reload<br>systemctl enable --now postgresql<br><br></code></pre></td></tr></table></figure>

<p>错误积累</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">#每次我启动pgsql的时候就有这个东西<br><br><span class="hljs-number">2024</span><span class="hljs-number">-09</span><span class="hljs-number">-14</span> <span class="hljs-number">14</span>:<span class="hljs-number">34</span>:<span class="hljs-number">03.196</span> CST [<span class="hljs-number">17746</span>] HINT:  <span class="hljs-keyword">Is</span> another postmaster (PID <span class="hljs-number">16042</span>) running <span class="hljs-keyword">in</span> data directory &quot;/data/postgresql/data&quot;?<br> stopped waiting<br>pg_ctl: could <span class="hljs-keyword">not</span> <span class="hljs-keyword">start</span> <span class="hljs-keyword">server</span><br><br>#意思是有个pid进程在运行，杀掉它就行了<br>sudo kill <span class="hljs-number">-9</span> <span class="hljs-number">16042</span><br></code></pre></td></tr></table></figure>

<h2 id="安装redis"><a href="#安装redis" class="headerlink" title="安装redis"></a>安装redis</h2><p>操作节点：[zujian]</p>
<h3 id="安装redis-1"><a href="#安装redis-1" class="headerlink" title="安装redis"></a>安装redis</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">wget</span> https://download.redis.io/releases/redis-<span class="hljs-number">7</span>.<span class="hljs-number">2</span>.<span class="hljs-number">4</span>.tar.gz<br><span class="hljs-attribute">tar</span> zxvf redis-<span class="hljs-number">7</span>.<span class="hljs-number">2</span>.<span class="hljs-number">4</span>.tar.gz <br><span class="hljs-attribute">mv</span> redis-<span class="hljs-number">7</span>.<span class="hljs-number">2</span>.<span class="hljs-number">4</span> /usr/local/bin/<br><span class="hljs-attribute">cd</span> /usr/local/bin/redis-<span class="hljs-number">7</span>.<span class="hljs-number">2</span>.<span class="hljs-number">4</span><br><span class="hljs-attribute">make</span> &amp;&amp; make install<br></code></pre></td></tr></table></figure>

<h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs awk">vi <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/bin/</span>redis-<span class="hljs-number">7.2</span>.<span class="hljs-number">4</span>/redis.conf<br><br><span class="hljs-comment">#bind 127.0.0.1 -::1  #注释掉bind的行，允许任何主机连接；</span><br>daemonize yes       <span class="hljs-comment">#将no修改为yes，使redis可以使用守护进程方式启动；</span><br>requirepass <span class="hljs-number">123456</span>   <span class="hljs-comment">#添加这行，设置redis连接的auth密码（123456）</span><br>protected-mode no  <span class="hljs-comment">#禁用保护模式</span><br><br>以下是一步到位将以上四个命令全部实现<br>sed -i <span class="hljs-string">&#x27;s/^bind 127.0.0.1 -::1/#bind 127.0.0.1 -::1/&#x27;</span> <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/bin/</span>redis-<span class="hljs-number">7.2</span>.<span class="hljs-number">4</span>/redis.conf<br>sed -i <span class="hljs-string">&#x27;s/^daemonize no/daemonize yes/&#x27;</span> <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/bin/</span>redis-<span class="hljs-number">7.2</span>.<span class="hljs-number">4</span>/redis.conf<br>echo -e <span class="hljs-string">&quot;\nrequirepass 123456&quot;</span> &gt;&gt; <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/bin/</span>redis-<span class="hljs-number">7.2</span>.<span class="hljs-number">4</span>/redis.conf<br>sed -i <span class="hljs-string">&#x27;s/^protected-mode yes/protected-mode no/&#x27;</span> <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/bin/</span>redis-<span class="hljs-number">7.2</span>.<span class="hljs-number">4</span>/redis.conf<br><br></code></pre></td></tr></table></figure>

<h3 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h3><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs axapta">redis-<span class="hljs-keyword">server</span> redis.conf<br></code></pre></td></tr></table></figure>

<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs elixir">[root<span class="hljs-variable">@zujian</span> redis<span class="hljs-number">-7.2</span>.<span class="hljs-number">4</span>]<span class="hljs-comment"># redis-server redis.conf</span><br><span class="hljs-number">2226</span><span class="hljs-symbol">:C</span> <span class="hljs-number">20</span> <span class="hljs-title class_">Apr</span> <span class="hljs-number">2024</span> <span class="hljs-number">17</span><span class="hljs-symbol">:</span><span class="hljs-number">10</span><span class="hljs-symbol">:</span><span class="hljs-number">45.039</span> <span class="hljs-comment"># WARNING Memory overcommit must be enabled! Without it, a background save or replication may fail under low memory condition. Being disabled, it can also cause failures without low memory condition, see https://github.com/jemalloc/jemalloc/issues/1328. To fix this issue add &#x27;vm.overcommit_memory = 1&#x27; to /etc/sysctl.conf and then reboot or run the command &#x27;sysctl vm.overcommit_memory=1&#x27; for this to take effect.</span><br></code></pre></td></tr></table></figure>

<p>Redis在启动时可能会出现这样的日志：在分析这个问题之前， 首先要弄清楚什么是overcommit？ <code>Linux操作系统对大部分申请内存的请求都回复yes</code>，<code> 以便能运行更多的程序</code>。 因为申请内存后， 并不会马上使用内存， 这种技术叫做<code>overcommit</code>。如果Redis在启动时有上面的日志， 说明vm.overcommit_memory&#x3D;0， Redis提示把它设置为1。<br>vm.overcommit_memory用来设置内存分配策略， 有三个可选值， 如表：可用内存代表物理内存与swap之和</p>
<p><img src="/../img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/cc85a53780cebc3b5cc317e42bf82667697559838-1728463576637-6.png" srcset="/img/loading.gif" lazyload alt="image-20240420171525086"></p>
<p>解决办法：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;vm.overcommit_memory=1&quot;</span> &gt;&gt; /etc/sysctl.<span class="hljs-keyword">conf</span><br>sysctl <span class="hljs-keyword">vm</span>.overcommit_memory=<span class="hljs-number">1</span><br>redis-server redis.<span class="hljs-keyword">conf</span><br></code></pre></td></tr></table></figure>

<p>再重新启动就可以查看版本和端口号了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@zujian redis-7.2.4]# redis-cli -v<br>redis-cli 7.2.4<br>[root@zujian redis-7.2.4]# ps aux |grep 6379<br>root        2227  0.0  0.3  68412 10888 ?        Ssl  17:10   0:00 redis-server *:6379<br>root        5427  0.0  0.0  22096  2300 pts/0    S+   17:19   0:00 grep --color=auto 6379<br><span class="hljs-meta prompt_">#</span><span class="language-bash">redis-server有这个就行</span><br></code></pre></td></tr></table></figure>

<p>关闭服务（只是普及知识，测试可用，不要随意关闭）</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">redis-cli shutdown<br></code></pre></td></tr></table></figure>

<h3 id="客户端连接redis"><a href="#客户端连接redis" class="headerlink" title="客户端连接redis"></a>客户端连接redis</h3><p>操作节点：[zujian]</p>
<p>将redis-cli的工具复制到Harbor1，harbor2</p>
<p>查看redis-cli工具位置</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@zujian]<span class="hljs-comment"># which redis-cli</span><br><span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/bin/</span>redis-cli<br></code></pre></td></tr></table></figure>

<p>复制</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">which redis-cli<br>scp <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/bin/</span>redis-cli harbor1:<span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/bin/</span><br>scp <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/bin/</span>redis-cli harbor2:<span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/bin/</span><br></code></pre></td></tr></table></figure>

<p>操作节点：[harbor1,harbor2]</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">redis</span>-cli -h <span class="hljs-number">192.168.48.108</span> -p <span class="hljs-number">6379</span> -a <span class="hljs-number">123456</span><br></code></pre></td></tr></table></figure>

<p><img src="/../img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/3a96c4fc4c335cc4dc09467e61b3e715697559838-1728463576637-7.png" srcset="/img/loading.gif" lazyload alt="image-20240420232245510"></p>
<p><img src="/../img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/d86e256aeb0b0418243b71a4dd46f434697559838-1728463576637-8.png" srcset="/img/loading.gif" lazyload alt="image-20240420232257725"></p>
<p>到此redis安装成功</p>
<h3 id="设置启动服务-1"><a href="#设置启动服务-1" class="headerlink" title="设置启动服务"></a>设置启动服务</h3><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs gradle">cat &gt;<span class="hljs-regexp">/etc/i</span>nit.d/redis-start.sh&lt;&lt; <span class="hljs-string">&quot;EOF&quot;</span><br><span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/bin/</span>redis-server <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/bin/</span>redis-<span class="hljs-number">7.2</span>.<span class="hljs-number">4</span>/redis.conf<br>EOF<br>cat &gt;<span class="hljs-regexp">/etc/i</span>nit.d/redis-stop.sh&lt;&lt; <span class="hljs-string">&quot;EOF&quot;</span><br><span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/bin/</span>redis-cli -a <span class="hljs-number">123456</span> shutdown<br>EOF<br><br>sudo chmod +x <span class="hljs-regexp">/etc/i</span>nit.d/redis-start.sh<br>sudo chmod +x <span class="hljs-regexp">/etc/i</span>nit.d/redis-stop.sh<br><br>cat &gt;<span class="hljs-regexp">/etc/</span>systemd<span class="hljs-regexp">/system/</span>redis.service &lt;&lt; <span class="hljs-string">&quot;EOF&quot;</span><br>[Unit]<br><span class="hljs-keyword">Description</span>=redis Service<br><br>[Service]<br>Type=oneshot<br>user=root<br>RemainAfterExit=<span class="hljs-keyword">true</span><br>ExecStart=<span class="hljs-regexp">/usr/</span>bin<span class="hljs-regexp">/sudo /</span>etc<span class="hljs-regexp">/init.d/</span>redis-start.sh<br>ExecStop=<span class="hljs-regexp">/usr/</span>bin<span class="hljs-regexp">/sudo /</span>etc<span class="hljs-regexp">/init.d/</span>redis-stop.sh<br>[Install]<br>WantedBy=multi-user.target<br>EOF<br>systemctl daemon-reload<br>systemctl enable --now redis<br></code></pre></td></tr></table></figure>

<h2 id="NFS共享存储安装"><a href="#NFS共享存储安装" class="headerlink" title="NFS共享存储安装"></a>NFS共享存储安装</h2><p>操作节点：[zujian]</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs awk">dnf install -y nfs-utils<br>systemctl enable --now nfs<br><span class="hljs-comment">#创建远程共享目录</span><br>mkdir -p <span class="hljs-regexp">/data/</span>harbor_data<br><br>cat &gt;&gt; <span class="hljs-regexp">/etc/</span>exports &lt;&lt; <span class="hljs-string">&quot;EOF&quot;</span><br><span class="hljs-regexp">/data/</span>harbor_data <span class="hljs-number">192.168</span>.<span class="hljs-number">48.0</span>/<span class="hljs-number">24</span>(rw,no_root_squash)<br>EOF<br><span class="hljs-comment">#使配置生效</span><br>exportfs -arv<br><br><span class="hljs-comment">#生效结果</span><br>[root@zujian ~]<span class="hljs-comment"># showmount -e</span><br>Export list <span class="hljs-keyword">for</span> zujian:<br><span class="hljs-regexp">/data/</span>harbor_data <span class="hljs-number">192.168</span>.<span class="hljs-number">48.0</span>/<span class="hljs-number">24</span><br><br></code></pre></td></tr></table></figure>

<p>操作节点：[harbor1,harbor2]</p>
<p>Harbor1、harbor2机器上安装nfs-utils客户端并挂载共享存储</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs awk">dnf install -y nfs-utils<br>systemctl enable --now nfs<br>mkdir -p <span class="hljs-regexp">/data/</span>harbor_data<br>cat &gt;&gt;<span class="hljs-regexp">/etc/</span>fstab&lt;&lt;<span class="hljs-string">&quot;EOF&quot;</span><br><span class="hljs-number">192.168</span>.<span class="hljs-number">48.108</span>:<span class="hljs-regexp">/data/</span>harbor_data <span class="hljs-regexp">/data/</span>harbor_data nfs defaults <span class="hljs-number">0</span> <span class="hljs-number">0</span><br>EOF<br>mount -a<br>df -h | grep harbor<br><span class="hljs-comment">#以下是挂载成功</span><br>[root@harbor1 ~]<span class="hljs-comment"># df -h | grep harbor</span><br><span class="hljs-number">192.168</span>.<span class="hljs-number">48.108</span>:<span class="hljs-regexp">/data/</span>harbor_data   <span class="hljs-number">63</span>G  <span class="hljs-number">3.0</span>G   <span class="hljs-number">57</span>G   <span class="hljs-number">6</span>% <span class="hljs-regexp">/data/</span>harbor_data<br><br>[root@harbor2 ~]<span class="hljs-comment"># df -h | grep harbor</span><br><span class="hljs-number">192.168</span>.<span class="hljs-number">48.108</span>:<span class="hljs-regexp">/data/</span>harbor_data   <span class="hljs-number">63</span>G  <span class="hljs-number">3.0</span>G   <span class="hljs-number">57</span>G   <span class="hljs-number">6</span>% <span class="hljs-regexp">/data/</span>harbor_data<br><br></code></pre></td></tr></table></figure>

<h2 id="harbor仓库安装"><a href="#harbor仓库安装" class="headerlink" title="harbor仓库安装"></a>harbor仓库安装</h2><p>操作节点：[harbor1,harbor2]</p>
<h3 id="安装docker"><a href="#安装docker" class="headerlink" title="安装docker"></a>安装docker</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs awk">wget https:<span class="hljs-regexp">//</span>download.docker.com<span class="hljs-regexp">/linux/</span>static<span class="hljs-regexp">/stable/</span>x86_64/docker-<span class="hljs-number">26.0</span>.<span class="hljs-number">1</span>.tgz<br>tar xf docker-*.tgz<br>cp docker<span class="hljs-regexp">/* /u</span>sr<span class="hljs-regexp">/bin/</span><br><span class="hljs-comment">#创建containerd的service文件,并且启动</span><br>cat &gt;<span class="hljs-regexp">/etc/</span>systemd<span class="hljs-regexp">/system/</span>containerd.service &lt;&lt;EOF<br>[Unit]<br>Description=containerd container runtime<br>Documentation=https:<span class="hljs-regexp">//</span>containerd.io<br>After=network.target local-fs.target<br>[Service]<br>ExecStartPre=-<span class="hljs-regexp">/sbin/m</span>odprobe overlay<br>ExecStart=<span class="hljs-regexp">/usr/</span>bin/containerd<br>Type=notify<br>Delegate=yes<br>KillMode=process<br>Restart=always<br>RestartSec=<span class="hljs-number">5</span><br>LimitNPROC=infinity<br>LimitCORE=infinity<br>LimitNOFILE=<span class="hljs-number">1048576</span><br>TasksMax=infinity<br>OOMScoreAdjust=-<span class="hljs-number">999</span><br>[Install]<br>WantedBy=multi-user.target<br>EOF<br>systemctl enable --now containerd.service<br><br><span class="hljs-comment">#准备docker的service文件</span><br><br>cat &gt; <span class="hljs-regexp">/etc/</span>systemd<span class="hljs-regexp">/system/</span>docker.service &lt;&lt;EOF<br>[Unit]<br>Description=Docker Application Container Engine<br>Documentation=https:<span class="hljs-regexp">//</span>docs.docker.com<br>After=network-online.target firewalld.service containerd.service<br>Wants=network-online.target<br>Requires=docker.socket containerd.service<br>[Service]<br>Type=notify<br>ExecStart=<span class="hljs-regexp">/usr/</span>bin<span class="hljs-regexp">/dockerd -H fd:/</span><span class="hljs-regexp">/ --containerd=/</span>run<span class="hljs-regexp">/containerd/</span>containerd.sock<br>ExecReload=<span class="hljs-regexp">/bin/</span>kill -s HUP <span class="hljs-variable">$MAINPID</span><br>TimeoutSec=<span class="hljs-number">0</span><br>RestartSec=<span class="hljs-number">2</span><br>Restart=always<br>StartLimitBurst=<span class="hljs-number">3</span><br>StartLimitInterval=<span class="hljs-number">60</span>s<br>LimitNOFILE=infinity<br>LimitNPROC=infinity<br>LimitCORE=infinity<br>TasksMax=infinity<br>Delegate=yes<br>KillMode=process<br>OOMScoreAdjust=-<span class="hljs-number">500</span><br>[Install]<br>WantedBy=multi-user.target<br>EOF<br><br><br><span class="hljs-comment">#准备docker的socket文件</span><br><br>cat &gt; <span class="hljs-regexp">/etc/</span>systemd<span class="hljs-regexp">/system/</span>docker.socket &lt;&lt;EOF<br>[Unit]<br>Description=Docker Socket <span class="hljs-keyword">for</span> the API<br>[Socket]<br>ListenStream=<span class="hljs-regexp">/var/</span>run/docker.sock<br>SocketMode=<span class="hljs-number">0660</span><br>SocketUser=root<br>SocketGroup=docker<br>[Install]<br>WantedBy=sockets.target<br>EOF<br>groupadd docker<br><br>systemctl enable --now docker.socket  &amp;&amp; systemctl enable --now docker.service<br><br><br><span class="hljs-comment">#验证</span><br>mkdir <span class="hljs-regexp">/etc/</span>docker<br>cat &gt;<span class="hljs-regexp">/etc/</span>docker/daemon.json &lt;&lt;EOF<br>&#123;<br>  <span class="hljs-string">&quot;exec-opts&quot;</span>: [<span class="hljs-string">&quot;native.cgroupdriver=systemd&quot;</span>],<br>  <span class="hljs-string">&quot;registry-mirrors&quot;</span>: [<br>    <span class="hljs-string">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span>,<br>    <span class="hljs-string">&quot;http://hub-mirror.c.163.com&quot;</span>,<br>    <span class="hljs-string">&quot;https://pw860av8.mirror.aliyuncs.com&quot;</span><br>  ],<br>  <span class="hljs-string">&quot;max-concurrent-downloads&quot;</span>: <span class="hljs-number">10</span>,<br>  <span class="hljs-string">&quot;log-driver&quot;</span>: <span class="hljs-string">&quot;json-file&quot;</span>,<br>  <span class="hljs-string">&quot;log-level&quot;</span>: <span class="hljs-string">&quot;warn&quot;</span>,<br>  <span class="hljs-string">&quot;log-opts&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;max-size&quot;</span>: <span class="hljs-string">&quot;500m&quot;</span>,<br>    <span class="hljs-string">&quot;max-file&quot;</span>: <span class="hljs-string">&quot;3&quot;</span><br>    &#125;,<br>  <span class="hljs-string">&quot;data-root&quot;</span>: <span class="hljs-string">&quot;/var/lib/docker&quot;</span><br>&#125;<br>EOF<br>systemctl restart docker<br>docker -v<br><br></code></pre></td></tr></table></figure>

<h3 id="安装docker-compose"><a href="#安装docker-compose" class="headerlink" title="安装docker-compose"></a>安装docker-compose</h3><p>操作节点：[harbor1,harbor2]</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk">wget https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/docker/</span>compose<span class="hljs-regexp">/releases/</span>download<span class="hljs-regexp">/v2.26.1/</span>docker-compose-linux-x86_64<br>mv docker-compose-linux-x86_64 <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/bin/</span>docker-compose<br>chmod +x <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/bin/</span>docker-compose<br>docker-compose version<br></code></pre></td></tr></table></figure>

<h3 id="配置内核参数并使之生效"><a href="#配置内核参数并使之生效" class="headerlink" title="配置内核参数并使之生效"></a>配置内核参数并使之生效</h3><p>操作节点：[harbor1,harbor2]</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs stylus">modprobe br_netfilter<br>cat &gt;&gt; /etc/sysctl<span class="hljs-selector-class">.conf</span> &lt;&lt;EOF<br>net<span class="hljs-selector-class">.bridge</span><span class="hljs-selector-class">.bridge-nf-call-ip6tables</span> = <span class="hljs-number">1</span><br>net<span class="hljs-selector-class">.bridge</span><span class="hljs-selector-class">.bridge-nf-call-iptables</span> = <span class="hljs-number">1</span><br>net<span class="hljs-selector-class">.ipv4</span><span class="hljs-selector-class">.ip_forward</span> = <span class="hljs-number">1</span> #路由转发<br>EOF<br>sysctl -p<br></code></pre></td></tr></table></figure>

<h3 id="下载harbor包并配置文件"><a href="#下载harbor包并配置文件" class="headerlink" title="下载harbor包并配置文件"></a>下载harbor包并配置文件</h3><p>操作节点：[harbor1,harbor2]</p>
<p>下载离线包offline字样</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs awk">wget https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/goharbor/</span>harbor<span class="hljs-regexp">/releases/</span>download<span class="hljs-regexp">/v2.9.4/</span>harbor-offline-installer-v2.<span class="hljs-number">9.4</span>.tgz<br>tar zxvf harbor-offline-installer-v2.<span class="hljs-number">9.4</span>.tgz<br>mv harbor <span class="hljs-regexp">/var/</span><br>cd <span class="hljs-regexp">/var/</span>harbor/<br><br>[root@harbor1 harbor]<span class="hljs-comment"># ls</span><br>common.sh  harbor.v2.<span class="hljs-number">9.4</span>.tar.gz  harbor.yml.tmpl  install.sh  LICENSE  prepare<br><br>cp harbor.yml.tmpl harbor.yml<br></code></pre></td></tr></table></figure>

<p>配置harbor文件</p>
<p><font color='red'>操作节点：[harbor1]</font></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">vi <span class="hljs-regexp">/var/</span>harbor/harbor.yml<br></code></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">hostname:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.48</span><span class="hljs-number">.106</span>  <span class="hljs-comment">#harbor1</span><br><span class="hljs-attr">http:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8081</span><br>  <br><span class="hljs-comment">#https:       #先注释https协议，后面再实现</span><br> <span class="hljs-comment"># port: 443</span><br> <span class="hljs-comment"># certificate: /your/certificate/path</span><br> <span class="hljs-comment"># private_key: /your/private/key/path</span><br><br><span class="hljs-comment">## 启用外部代理，启用后hostname将不再使用</span><br><span class="hljs-attr">external_url:</span> <span class="hljs-string">https://192.168.48.100</span><br><br><span class="hljs-comment">#harbor页面密码</span><br><span class="hljs-attr">harbor_admin_password:</span> <span class="hljs-string">Harbor12345</span><br><br><br><span class="hljs-comment">#配置NFS共享存储</span><br><span class="hljs-attr">data_volume:</span> <span class="hljs-string">/data/harbor_data</span><br><span class="hljs-attr">_version:</span> <span class="hljs-number">2.9</span><span class="hljs-number">.0</span><br><span class="hljs-comment">#配置数据库</span><br><span class="hljs-attr">external_database:</span><br>  <span class="hljs-attr">harbor:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.48</span><span class="hljs-number">.108</span>  <span class="hljs-comment"># 数据库主机地址</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5432</span>              <span class="hljs-comment"># 数据库端口</span><br>    <span class="hljs-attr">db_name:</span> <span class="hljs-string">registry</span>    <span class="hljs-comment"># 数据库名称</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">postgres</span>        <span class="hljs-comment"># 连接该数据库的用户名</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>    <span class="hljs-comment"># 连接数据库的密码</span><br>    <span class="hljs-attr">ssl_mode:</span> <span class="hljs-string">disable</span><br>    <span class="hljs-attr">max_idle_conns:</span> <span class="hljs-number">50</span><br>    <span class="hljs-attr">max_open_conns:</span> <span class="hljs-number">100</span><br>  <span class="hljs-attr">notary_server:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.48</span><span class="hljs-number">.108</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5432</span><br>    <span class="hljs-attr">db_name:</span> <span class="hljs-string">notary_server</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">postgres</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span><br>    <span class="hljs-attr">ssl_mode:</span> <span class="hljs-string">disable</span><br>  <span class="hljs-attr">notary_signer:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.48</span><span class="hljs-number">.108</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5432</span><br>    <span class="hljs-attr">db_name:</span> <span class="hljs-string">notary_signer</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">postgres</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span><br>    <span class="hljs-attr">ssl_mode:</span> <span class="hljs-string">disable</span> <br><span class="hljs-comment">#配置redis</span><br><span class="hljs-attr">external_redis:</span><br>  <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.48</span><span class="hljs-number">.108</span><span class="hljs-string">:6379</span> <span class="hljs-comment">#redis服务IP地址和端口号</span><br>  <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>   <span class="hljs-comment">#连接外部redis服务的密码</span><br>  <span class="hljs-attr">registry_db_index:</span> <span class="hljs-number">1</span>  <br>  <span class="hljs-attr">jobservice_db_index:</span> <span class="hljs-number">2</span> <span class="hljs-comment">#job服务的数据库索引</span><br>  <span class="hljs-attr">chartmuseum_db_index:</span> <span class="hljs-number">3</span>  <span class="hljs-comment">#chartmuseum插件的Redis索引</span><br>  <span class="hljs-attr">trivy_db_index:</span> <span class="hljs-number">5</span>   <span class="hljs-comment">#Trivy扫描器的数据索引</span><br>  <span class="hljs-attr">idle_timeout_seconds:</span> <span class="hljs-number">30</span>  <span class="hljs-comment">#超时时间</span><br><br><span class="hljs-comment">#启用metrics数据采集插件</span><br><span class="hljs-attr">metric:</span><br>  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">9090</span><br>  <span class="hljs-attr">path:</span> <span class="hljs-string">/metrics</span><br><br><span class="hljs-attr">trivy:</span><br>  <span class="hljs-attr">ignore_unfixed:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">skip_update:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">skip_java_db_update:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">offline_scan:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">security_check:</span> <span class="hljs-string">vuln</span><br>  <span class="hljs-attr">insecure:</span> <span class="hljs-literal">false</span><br><span class="hljs-attr">jobservice:</span><br>  <span class="hljs-attr">max_job_workers:</span> <span class="hljs-number">10</span><br>  <span class="hljs-attr">job_loggers:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">STD_OUTPUT</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">FILE</span><br>  <span class="hljs-attr">logger_sweeper_duration:</span> <span class="hljs-number">1</span> <span class="hljs-comment">#days</span><br><span class="hljs-attr">notification:</span><br>  <span class="hljs-attr">webhook_job_max_retry:</span> <span class="hljs-number">3</span><br>  <span class="hljs-attr">webhook_job_http_client_timeout:</span> <span class="hljs-number">3</span> <span class="hljs-comment">#seconds</span><br><span class="hljs-attr">log:</span><br>  <span class="hljs-attr">level:</span> <span class="hljs-string">info</span><br>  <span class="hljs-attr">local:</span><br>    <span class="hljs-attr">rotate_count:</span> <span class="hljs-number">50</span><br>    <span class="hljs-attr">rotate_size:</span> <span class="hljs-string">200M</span><br>    <span class="hljs-attr">location:</span> <span class="hljs-string">/var/log/harbor</span><br><span class="hljs-attr">proxy:</span><br>  <span class="hljs-attr">http_proxy:</span><br>  <span class="hljs-attr">https_proxy:</span><br>  <span class="hljs-attr">no_proxy:</span><br>  <span class="hljs-attr">components:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">core</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">jobservice</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">trivy</span><br><span class="hljs-attr">upload_purging:</span><br>  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">age:</span> <span class="hljs-string">168h</span><br>  <span class="hljs-attr">interval:</span> <span class="hljs-string">24h</span><br>  <span class="hljs-attr">dryrun:</span> <span class="hljs-literal">false</span><br><span class="hljs-attr">cache:</span><br>  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">expire_hours:</span> <span class="hljs-number">24</span><br></code></pre></td></tr></table></figure>

<p><font color='red'>操作节点：[harbor2]</font></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">vi <span class="hljs-regexp">/var/</span>harbor/harbor.yml<br></code></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">hostname:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.48</span><span class="hljs-number">.107</span>  <span class="hljs-comment">#harbor2</span><br><span class="hljs-attr">http:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8081</span><br>  <br><span class="hljs-comment">#https:       #先注释https协议，后面再实现</span><br> <span class="hljs-comment"># port: 443</span><br> <span class="hljs-comment"># certificate: /your/certificate/path</span><br> <span class="hljs-comment"># private_key: /your/private/key/path</span><br><br><span class="hljs-comment">## 启用外部代理，启用后hostname将不再使用</span><br><span class="hljs-attr">external_url:</span> <span class="hljs-string">https://192.168.48.100</span><br><br><span class="hljs-comment">#harbor页面密码</span><br><span class="hljs-attr">harbor_admin_password:</span> <span class="hljs-string">Harbor12345</span><br><br><span class="hljs-comment">#配置NFS共享存储</span><br><span class="hljs-attr">data_volume:</span> <span class="hljs-string">/data/harbor_data</span><br><span class="hljs-attr">_version:</span> <span class="hljs-number">2.9</span><span class="hljs-number">.0</span><br><span class="hljs-comment">#配置数据库</span><br><span class="hljs-attr">external_database:</span><br>  <span class="hljs-attr">harbor:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.48</span><span class="hljs-number">.108</span>  <span class="hljs-comment"># 数据库主机地址</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5432</span>              <span class="hljs-comment"># 数据库端口</span><br>    <span class="hljs-attr">db_name:</span> <span class="hljs-string">registry</span>    <span class="hljs-comment"># 数据库名称</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">postgres</span>        <span class="hljs-comment"># 连接该数据库的用户名</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>    <span class="hljs-comment"># 连接数据库的密码</span><br>    <span class="hljs-attr">ssl_mode:</span> <span class="hljs-string">disable</span><br>    <span class="hljs-attr">max_idle_conns:</span> <span class="hljs-number">2</span><br>    <span class="hljs-attr">max_open_conns:</span> <span class="hljs-number">0</span><br><span class="hljs-attr">notary_server:</span><br>  <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.48</span><span class="hljs-number">.108</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">5432</span><br>  <span class="hljs-attr">db_name:</span> <span class="hljs-string">notary_server</span><br>  <span class="hljs-attr">username:</span> <span class="hljs-string">postgres</span><br>  <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span><br>  <span class="hljs-attr">ssl_mode:</span> <span class="hljs-string">disable</span><br><span class="hljs-attr">notary_signer:</span><br>  <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.48</span><span class="hljs-number">.108</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">5432</span><br>  <span class="hljs-attr">db_name:</span> <span class="hljs-string">notary_signer</span><br>  <span class="hljs-attr">username:</span> <span class="hljs-string">postgres</span><br>  <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span><br>  <span class="hljs-attr">ssl_mode:</span> <span class="hljs-string">disable</span> <br><span class="hljs-comment">#配置redis</span><br><span class="hljs-attr">external_redis:</span><br>  <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.48</span><span class="hljs-number">.108</span><span class="hljs-string">:6379</span> <span class="hljs-comment">#redis服务IP地址和端口号</span><br>  <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>   <span class="hljs-comment">#连接外部redis服务的密码</span><br>  <span class="hljs-attr">registry_db_index:</span> <span class="hljs-number">1</span>  <br>  <span class="hljs-attr">jobservice_db_index:</span> <span class="hljs-number">2</span> <span class="hljs-comment">#job服务的数据库索引</span><br>  <span class="hljs-attr">chartmuseum_db_index:</span> <span class="hljs-number">3</span>  <span class="hljs-comment">#chartmuseum插件的Redis索引</span><br>  <span class="hljs-attr">trivy_db_index:</span> <span class="hljs-number">5</span>   <span class="hljs-comment">#Trivy扫描器的数据索引</span><br>  <span class="hljs-attr">idle_timeout_seconds:</span> <span class="hljs-number">30</span>  <span class="hljs-comment">#超时时间</span><br><br><span class="hljs-comment">#启用metrics数据采集插件</span><br><span class="hljs-attr">metric:</span><br>  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">9090</span><br>  <span class="hljs-attr">path:</span> <span class="hljs-string">/metrics</span><br><br><span class="hljs-attr">trivy:</span><br>  <span class="hljs-attr">ignore_unfixed:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">skip_update:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">skip_java_db_update:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">offline_scan:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">security_check:</span> <span class="hljs-string">vuln</span><br>  <span class="hljs-attr">insecure:</span> <span class="hljs-literal">false</span><br><span class="hljs-attr">jobservice:</span><br>  <span class="hljs-attr">max_job_workers:</span> <span class="hljs-number">10</span><br>  <span class="hljs-attr">job_loggers:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">STD_OUTPUT</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">FILE</span><br>  <span class="hljs-attr">logger_sweeper_duration:</span> <span class="hljs-number">1</span> <span class="hljs-comment">#days</span><br><span class="hljs-attr">notification:</span><br>  <span class="hljs-attr">webhook_job_max_retry:</span> <span class="hljs-number">3</span><br>  <span class="hljs-attr">webhook_job_http_client_timeout:</span> <span class="hljs-number">3</span> <span class="hljs-comment">#seconds</span><br><span class="hljs-attr">log:</span><br>  <span class="hljs-attr">level:</span> <span class="hljs-string">info</span><br>  <span class="hljs-attr">local:</span><br>    <span class="hljs-attr">rotate_count:</span> <span class="hljs-number">50</span><br>    <span class="hljs-attr">rotate_size:</span> <span class="hljs-string">200M</span><br>    <span class="hljs-attr">location:</span> <span class="hljs-string">/var/log/harbor</span><br><span class="hljs-attr">proxy:</span><br>  <span class="hljs-attr">http_proxy:</span><br>  <span class="hljs-attr">https_proxy:</span><br>  <span class="hljs-attr">no_proxy:</span><br>  <span class="hljs-attr">components:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">core</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">jobservice</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">trivy</span><br><span class="hljs-attr">upload_purging:</span><br>  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">age:</span> <span class="hljs-string">168h</span><br>  <span class="hljs-attr">interval:</span> <span class="hljs-string">24h</span><br>  <span class="hljs-attr">dryrun:</span> <span class="hljs-literal">false</span><br><span class="hljs-attr">cache:</span><br>  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">expire_hours:</span> <span class="hljs-number">24</span><br></code></pre></td></tr></table></figure>

<h3 id="将配置文件注入到各级件中并安装"><a href="#将配置文件注入到各级件中并安装" class="headerlink" title="将配置文件注入到各级件中并安装"></a>将配置文件注入到各级件中并安装</h3><p>先提前下载镜像吧，这里用博主构建的镜像速度会快一点</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> pull registry.cn-hangzhou.aliyuncs.com/qianyios/prepare:v2.<span class="hljs-number">9</span>.<span class="hljs-number">4</span><br><span class="hljs-attribute">docker</span> tag registry.cn-hangzhou.aliyuncs.com/qianyios/prepare:v2.<span class="hljs-number">9</span>.<span class="hljs-number">4</span> goharbor/prepare:v2.<span class="hljs-number">9</span>.<span class="hljs-number">4</span><br></code></pre></td></tr></table></figure>

<p>开始注入</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /var/harbor/<br>./prepare<br></code></pre></td></tr></table></figure>

<p><img src="/../img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/7c9f2f4b584c99d6544e8eafce182714697559838-1728463576637-9.png" srcset="/img/loading.gif" lazyload alt="image-20240420230001756"></p>
<p>开始安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /var/harbor/<br>./install.sh<br></code></pre></td></tr></table></figure>

<p><img src="/../img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/641497d253efbd4cc87daa6e27ff29dc697559838-1728463576637-10.png" srcset="/img/loading.gif" lazyload alt="image-20240420230138644"></p>
<h3 id="配置自启动"><a href="#配置自启动" class="headerlink" title="配置自启动"></a>配置自启动</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs routeros">cat &gt;/usr/lib/systemd/system/harbor.service &lt;&lt; <span class="hljs-string">&quot;EOF&quot;</span><br>[Unit]<br><span class="hljs-attribute">Description</span>=Harbor<br><span class="hljs-attribute">After</span>=docker.service systemd-networkd.service systemd-resolved.service nfs-server.service<br><span class="hljs-attribute">Requires</span>=docker.service<br><span class="hljs-attribute">Documentation</span>=http://github.com/vmware/harbor<br>[Service]<br><span class="hljs-attribute">Type</span>=simple<br><span class="hljs-attribute">Restart</span>=on-failure<br><span class="hljs-attribute">RestartSec</span>=5<br><span class="hljs-attribute">ExecStart</span>=/usr/local/bin/docker-compose -f /var/harbor/docker-compose.yml up<br><span class="hljs-attribute">ExecStop</span>=/usr/local/bin/docker-compose -f /var/harbor/docker-compose.yml down<br>[Install]<br><span class="hljs-attribute">WantedBy</span>=multi-user.target<br>EOF<br>systemctl daemon-reload<br>systemctl <span class="hljs-built_in">enable</span> harbor --now<br></code></pre></td></tr></table></figure>

<p><code>大坑来了，之前找了两个星期都没解决的</code></p>
<p>到此，harbor安装完成，<code>但是你在网页可能会出现不能用admin登入，会显示密码错误</code>你需要进行下一步安装证书</p>
<p>原因：首先pg数据库在安装harbor时创建的admin是用sha256协议加密的</p>
<p><img src="/../img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/ed2a9dfd3cc2a61acb214481e3a2caf2697559838-1728463576637-11.png" srcset="/img/loading.gif" lazyload alt="image-20240430182121148"></p>
<p>而在我们harbor页面，我们并没有配置ssl证书，是http方式访问并没有sha256加密协议，意味着harbor再登入的时候，会出现密码错误，就是：网页登入验证<code>===/===</code>pg数据库验证，配置openssl证书，可以解决此问题,openssl包含sha256协议，这样就可以登入了。</p>
<p>OpenSSL是一个<code>强大的加密库</code>，广泛应用于互联网的各个角落，用于保护数据传输的安全。它实现了SSL和TLS协议，这些协议是现代网络安全的基石。</p>
<h2 id="配置ssl证书"><a href="#配置ssl证书" class="headerlink" title="配置ssl证书"></a>配置ssl证书</h2><p>操作节点：[harbor1,harbor2]</p>
<h3 id="生成ca证书"><a href="#生成ca证书" class="headerlink" title="生成ca证书"></a>生成ca证书</h3><p>创建一个放置证书相关的目录，并使用cd进入该目录</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-keyword">mkdir</span> /<span class="hljs-keyword">var</span>/harbor/cert&amp;&amp; <span class="hljs-keyword">cd</span>  /<span class="hljs-keyword">var</span>/harbor/cert<br>## 1. 生成<span class="hljs-keyword">CA</span>证书私钥<br>openssl genrsa -<span class="hljs-keyword">out</span> <span class="hljs-keyword">ca</span>.key 4096<br>## 2. 生成<span class="hljs-keyword">CA</span>证书，可调整 -subj 选项来表明域名名称等信息<br>openssl req -x509 -new -nodes -sha512 -days 3650 \<br> -subj <span class="hljs-string">&quot;/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=192.168.48.100&quot;</span> \<br> -key <span class="hljs-keyword">ca</span>.key \<br> -<span class="hljs-keyword">out</span> <span class="hljs-keyword">ca</span>.crt<br></code></pre></td></tr></table></figure>

<h3 id="生成服务器证书"><a href="#生成服务器证书" class="headerlink" title="生成服务器证书"></a>生成服务器证书</h3><p>认证证书通常包含证书请求<code>.csr</code>文件、签名证书<code>.crt</code>文件及私钥<code>.key</code>文件，我这里harbor配置的hostname是192.168.48.100，所以最终需要生成<code>192.168.48.100.crt、192.168.48.100.csr、192.168.48.100.key</code>三个文件。</p>
<ul>
<li>key：证书私钥，一般利用rsa等算法生成</li>
<li>csr：证书请求文件，利用证书私钥生成证书请求文件，该文件包含了服务器和地址等信息，申请人将该文件提交给CA机构，CA机构会根据该文件所携带的私钥信息来进行签名生成证书</li>
<li>crt：证书文件</li>
</ul>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-comment">## 1. 生成私钥</span><br>openssl genrsa -out <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">48</span>.<span class="hljs-number">100</span>.key <span class="hljs-number">4096</span><br><span class="hljs-comment">## 2. 生成csr文件</span><br>openssl req -<span class="hljs-keyword">sha512 </span>-new \<br>    -<span class="hljs-keyword">subj </span><span class="hljs-string">&quot;/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=192.168.48.100&quot;</span> \<br>    -key <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">48</span>.<span class="hljs-number">100</span>.key \<br>    -out <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">48</span>.<span class="hljs-number">100</span>.csr<br><span class="hljs-comment">## 3. 生成ssl匹配多域名文，例如既想使用域名又需要通过127.0.0.1本地地址登陆测试，可使用subjectAltName参数来进行配置</span><br>cat &gt; v3.<span class="hljs-keyword">ext </span>&lt;&lt;-EOF<br>authorityKeyIdentifier=keyid,issuer<br><span class="hljs-keyword">basicConstraints=CA:FALSE</span><br><span class="hljs-keyword"></span>keyUsage = <span class="hljs-keyword">digitalSignature, </span>nonRepudiation, keyEncipherment, dataEncipherment<br><span class="hljs-keyword">extendedKeyUsage </span>= serverAuth<br><span class="hljs-keyword">subjectAltName </span>= @alt_names<br><br>[alt_names]<br>DNS.<span class="hljs-number">1</span>=<span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">48</span>.<span class="hljs-number">100</span><br>DNS.<span class="hljs-number">2</span>=<span class="hljs-number">127</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span><br>IP.<span class="hljs-number">1</span>=<span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">48</span>.<span class="hljs-number">100</span><br>EOF<br><span class="hljs-comment">## 4. 根据v3.ext及csr文件请求生成crt证书文件</span><br>openssl x509 -req -<span class="hljs-keyword">sha512 </span>-days <span class="hljs-number">3650</span> \<br>    -<span class="hljs-keyword">extfile </span>v3.<span class="hljs-keyword">ext </span>\<br>    -CA ca.crt -CAkey ca.key -CAcreateserial \<br>    -in <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">48</span>.<span class="hljs-number">100</span>.csr \<br>    -out <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">48</span>.<span class="hljs-number">100</span>.crt<br></code></pre></td></tr></table></figure>

<h3 id="修改harbor配置文件"><a href="#修改harbor配置文件" class="headerlink" title="修改harbor配置文件"></a>修改harbor配置文件</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">cat</span> <span class="hljs-string">&gt;&gt;</span> <span class="hljs-string">/var/harbor/harbor.yml</span> <span class="hljs-string">&lt;&lt;</span> <span class="hljs-string">&quot;EOF&quot;</span><br><span class="hljs-attr">https:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">443</span><br>  <span class="hljs-attr">certificate:</span> <span class="hljs-string">/var/harbor/cert/192.168.48.100.crt</span><br>  <span class="hljs-attr">private_key:</span> <span class="hljs-string">/var/harbor/cert/192.168.48.100.key</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure>

<p>重新启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /var/harbor<br>docker-compose down -v<br>./prepare<br>docker-compose up -d<br></code></pre></td></tr></table></figure>

<h2 id="镜像上传及拉取测试"><a href="#镜像上传及拉取测试" class="headerlink" title="镜像上传及拉取测试"></a>镜像上传及拉取测试</h2><p>操作节点：[harbor1,harbor2,zujian,qianyios（测试客户端）]</p>
<p>找一台客户端装好<code>docker</code>进行测试</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs applescript">[root@qianyios ~]<span class="hljs-comment"># docker -v</span><br>Docker <span class="hljs-built_in">version</span> <span class="hljs-number">26.0</span><span class="hljs-number">.1</span>, build d260a54<br></code></pre></td></tr></table></figure>

<h3 id="新建私有镜像仓库"><a href="#新建私有镜像仓库" class="headerlink" title="新建私有镜像仓库"></a>新建私有镜像仓库</h3><p><img src="/../img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/5a8209041787cb65972b0a6803ff9cd8697559838-1728463576637-12.png" srcset="/img/loading.gif" lazyload alt="image-20240429225926063"></p>
<h3 id="客户端免https登陆"><a href="#客户端免https登陆" class="headerlink" title="客户端免https登陆"></a>客户端免https登陆</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 此时直接使用docker login登陆到harbor中，会报错，下面hostname和port是harbor的配置文件中设置的名称及端口</span><br><span class="hljs-comment">#以下是格式</span><br>[root@xxxx harbor]<span class="hljs-comment"># docker login [hostname]:[port]</span><br><br>可能会出现以下情况<br><span class="hljs-comment">#192.168.48.100是高可用vip</span><br>[root@harbor1 ~]<span class="hljs-comment"># docker login 192.168.48.100</span><br>Username: admin<br>Password:<br>Error response from daemon: Get <span class="hljs-string">&quot;https://192.168.48.100/v2/&quot;</span>: tls: failed to verify certificate: x509: certificate signed by unknown authority<br><br>[root@qianyios ~]<span class="hljs-comment"># docker login 192.168.48.106:8081</span><br>Username: admin<br>Password:<br>Error response from daemon: Get <span class="hljs-string">&quot;https://192.168.48.106:8081/v2/&quot;</span>: http: server gave HTTP response to HTTPS client<br>[root@qianyios ~]<span class="hljs-comment">#</span><br><br><span class="hljs-comment"># 客户端默认使用的是https协议，所以需要对docker做以下修改,在文件末尾添加insecure-registries</span><br>[root@qianyios ~]<span class="hljs-comment"># vim /etc/docker/daemon.json</span><br>&#123;<br>   ................<br>  <span class="hljs-string">&quot;registry-mirrors&quot;</span>: [],<span class="hljs-comment">#无关紧要，不用看,</span><br>  <span class="hljs-string">&quot;insecure-registries&quot;</span>: [ <span class="hljs-string">&quot;192.168.48.100&quot;</span> ],<span class="hljs-comment">#重要加这行，别忘了如果他不是最后一行一定要在末尾加逗号</span><br> ................<br>&#125;<br><br><span class="hljs-comment"># 修改后，重启docker使其生效</span><br>systemctl daemon-reload<br>systemctl restart docker<br><br><span class="hljs-comment"># 利用docker info查看是否添加上</span><br>[root@qianyios ~]<span class="hljs-comment"># docker info</span><br>Containers: 10<br> Running: 1<br> Paused: 0<br> Stopped: 9<br>Images: 37<br>...<br> Experimental: <span class="hljs-literal">false</span><br> Insecure Registries:<br>  192.168.48.100   <span class="hljs-comment">###要确保有这个才行</span><br>  127.0.0.0/8<br> Registry Mirrors:<br><br><br></code></pre></td></tr></table></figure>

<h3 id="扩展知识-containerd私有仓库配置（可略过）"><a href="#扩展知识-containerd私有仓库配置（可略过）" class="headerlink" title="扩展知识-containerd私有仓库配置（可略过）"></a>扩展知识-containerd私有仓库配置（可略过）</h3><p>在今后的K8s版本可能也会用containerd做为k8s的容器运行时，那么配置私有仓库也是一个头疼的事情。</p>
<p>在&#x2F;etc&#x2F;containerd&#x2F;config.toml会有以下两个信息，可以定位</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs csharp">[<span class="hljs-meta">plugins.<span class="hljs-string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.configs</span>]<br>[<span class="hljs-meta">plugins.<span class="hljs-string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors</span>]<br></code></pre></td></tr></table></figure>

<p>要在以上两个信息下配置东西如下：（理解，我下面有一步到位命令，不用手动加）</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">[plugins.<span class="hljs-string">&quot;io.containerd.grpc.v1.cri&quot;</span><span class="hljs-string">.registry.configs</span>]<br>  [plugins.<span class="hljs-string">&quot;io.containerd.grpc.v1.cri&quot;</span><span class="hljs-string">.registry.configs.</span><span class="hljs-string">&quot;192.168.48.100&quot;</span><span class="hljs-string">.tls</span>]<br>    insecure_skip_verify = <span class="hljs-literal">true</span>  <span class="hljs-comment"># 是否跳过安全认证</span><br>  [plugins.<span class="hljs-string">&quot;io.containerd.grpc.v1.cri&quot;</span><span class="hljs-string">.registry.configs.</span><span class="hljs-string">&quot;192.168.48.100&quot;</span><span class="hljs-string">.auth</span>]<br>    username = <span class="hljs-string">&quot;admin&quot;</span><br>    password = <span class="hljs-string">&quot;Harbor12345&quot;</span><br><br>[plugins.<span class="hljs-string">&quot;io.containerd.grpc.v1.cri&quot;</span><span class="hljs-string">.registry.mirrors</span>]<br>  [plugins.<span class="hljs-string">&quot;io.containerd.grpc.v1.cri&quot;</span><span class="hljs-string">.registry.mirrors.</span><span class="hljs-string">&quot;docker.io&quot;</span>]<br>    endpoint = [<span class="hljs-string">&quot;https://registry-1.docker.io&quot;</span>]<br>  [plugins.<span class="hljs-string">&quot;io.containerd.grpc.v1.cri&quot;</span><span class="hljs-string">.registry.mirrors.</span><span class="hljs-string">&quot;192.168.48.100&quot;</span>]<br>    endpoint = [<span class="hljs-string">&quot;http://192.168.48.100&quot;</span>]<br></code></pre></td></tr></table></figure>

<p><img src="/../img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/af7aaafb05cf9ffdbba39ac2020c6530697559838.png" srcset="/img/loading.gif" lazyload alt="image-20241009163343160"></p>
<p>添加Harbor信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">sed -i <span class="hljs-string">&#x27;/\[plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.configs\]/a \</span><br><span class="hljs-string">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.configs.&quot;192.168.48.100&quot;.tls]\</span><br><span class="hljs-string">          insecure_skip_verify = true  # 是否跳过安全认证\</span><br><span class="hljs-string">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.configs.&quot;192.168.48.100&quot;.auth]\</span><br><span class="hljs-string">          username = &quot;admin&quot;\</span><br><span class="hljs-string">          password = &quot;Harbor12345&quot;&#x27;</span> /etc/containerd/config.toml<br>sed -i <span class="hljs-string">&#x27;/\[plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors\]/a \</span><br><span class="hljs-string">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;docker.io&quot;]\</span><br><span class="hljs-string">          endpoint = [&quot;https://registry-1.docker.io&quot;]\</span><br><span class="hljs-string">        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;192.168.48.100&quot;]\</span><br><span class="hljs-string">          endpoint = [&quot;http://192.168.48.100&quot;]&#x27;</span> /etc/containerd/config.toml<br></code></pre></td></tr></table></figure>

<p>最后尝试下载镜像</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">crictl pull <span class="hljs-number">192.168</span>.<span class="hljs-number">48.100</span><span class="hljs-regexp">/cicd/</span>jenkins:latest<br></code></pre></td></tr></table></figure>

<p>这个是我自己上传的镜像，已经在harbor仓库了，我现在在有containerd的客户端进行拉取看看能不能成功</p>
<p><img src="/../img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/133a098cfbc1fa958c5efb8f6a103c11697559838.png" srcset="/img/loading.gif" lazyload alt="image-20241009164535687"></p>
<p>显然已经成功</p>
<h3 id="进行登入测试"><a href="#进行登入测试" class="headerlink" title="进行登入测试"></a>进行登入测试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker login 192.168.48.100<br><br>[root@harbor1 ~]<span class="hljs-comment"># docker login 192.168.48.100</span><br>Username: admin<br>Password:<br>WARNING! Your password will be stored unencrypted <span class="hljs-keyword">in</span> /root/.docker/config.json.<br>Configure a credential helper to remove this warning. See<br>https://docs.docker.com/engine/reference/commandline/login/<span class="hljs-comment">#credentials-store</span><br><br>Login Succeeded<br><br>[root@qianyios ~]<span class="hljs-comment"># docker login 192.168.48.100</span><br>Username: admin<br>Password:<br>WARNING! Your password will be stored unencrypted <span class="hljs-keyword">in</span> /root/.docker/config.json.<br>Configure a credential helper to remove this warning. See<br>https://docs.docker.com/engine/reference/commandline/login/<span class="hljs-comment">#credentials-store</span><br><br>Login Succeeded<br><br><span class="hljs-comment">##经过测试，通过添加&quot;insecure-registries&quot;: [ &quot;192.168.48.100&quot; ]可以免除https登入</span><br><br></code></pre></td></tr></table></figure>

<h3 id="上传镜像测试"><a href="#上传镜像测试" class="headerlink" title="上传镜像测试"></a>上传镜像测试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#下载一个nginx镜像，然后tag，再上传</span><br>[root@qianyios ~]<span class="hljs-comment"># docker pull nginx</span><br>Using default tag: latest<br>latest: Pulling from library/nginx<br>a2abf6c4d29d: Pull complete<br>a9edb18cadd1: Pull complete<br>589b7251471a: Pull complete<br>186b1aaa4aa6: Pull complete<br>b4df32aa5a72: Pull complete<br>a0bcbecc962e: Pull complete<br>Digest: sha256:0d17b565c37bcbd895e9d92315a05c1c3c9a29f762b011a10c54a66cd53c9b31<br>Status: Downloaded newer image <span class="hljs-keyword">for</span> nginx:latest<br>docker.io/library/nginx:latest<br><span class="hljs-comment">#在此下载了最新版的nginx镜像tag为lastest</span><br></code></pre></td></tr></table></figure>

<p>我们进入当刚刚创建的仓库，点推送指令</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs crmsh"><span class="hljs-comment">#推送镜像命令格式</span><br><span class="hljs-comment">#docker tag 源镜像名[:TAG] 192.168.48.100/qianyios/新镜像名[:TAG]</span><br>docker <span class="hljs-keyword">tag</span> <span class="hljs-title">SOURCE_IMAGE</span>[:<span class="hljs-keyword">TAG</span>] <span class="hljs-number">192.168</span>.<span class="hljs-number">48.100</span>/qianyios/REPOSITORY[:<span class="hljs-keyword">TAG</span>]<br></code></pre></td></tr></table></figure>

<p><img src="/../img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/12397c8570bbb17f0a2de6c6ffad4541697559838-1728463576637-13.png" srcset="/img/loading.gif" lazyload alt="image-20240430180549537"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#我们将nginx镜像打上tag   </span><br>[<span class="hljs-string">root@qianyios</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># docker images</span><br><span class="hljs-string">REPOSITORY</span>   <span class="hljs-string">TAG</span>       <span class="hljs-string">IMAGE</span> <span class="hljs-string">ID</span>       <span class="hljs-string">CREATED</span>       <span class="hljs-string">SIZE</span><br><span class="hljs-string">nginx</span>        <span class="hljs-string">latest</span>    <span class="hljs-string">605c77e624dd</span>   <span class="hljs-number">2</span> <span class="hljs-string">years</span> <span class="hljs-string">ago</span>   <span class="hljs-string">141MB</span><br><span class="hljs-comment">#605的意思是镜像id的前三位数字，我们指定为V1标签，相当于版本号。</span><br>[<span class="hljs-string">root@qianyios</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># docker tag 605 192.168.48.100/qianyios/nginx:V1</span><br>[<span class="hljs-string">root@qianyios</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># docker images</span><br><span class="hljs-string">REPOSITORY</span>                      <span class="hljs-string">TAG</span>       <span class="hljs-string">IMAGE</span> <span class="hljs-string">ID</span>       <span class="hljs-string">CREATED</span>       <span class="hljs-string">SIZE</span><br><span class="hljs-number">192.168</span><span class="hljs-number">.48</span><span class="hljs-number">.100</span><span class="hljs-string">/qianyios/nginx</span>   <span class="hljs-string">V1</span>        <span class="hljs-string">605c77e624dd</span>   <span class="hljs-number">2</span> <span class="hljs-string">years</span> <span class="hljs-string">ago</span>   <span class="hljs-string">141MB</span><br><span class="hljs-string">nginx</span>                           <span class="hljs-string">latest</span>    <span class="hljs-string">605c77e624dd</span>   <span class="hljs-number">2</span> <span class="hljs-string">years</span> <span class="hljs-string">ago</span>   <span class="hljs-string">141MB</span><br><span class="hljs-comment">#开始上传</span><br>[<span class="hljs-string">root@qianyios</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># docker push 192.168.48.100/qianyios/nginx:V1</span><br><span class="hljs-string">The</span> <span class="hljs-string">push</span> <span class="hljs-string">refers</span> <span class="hljs-string">to</span> <span class="hljs-string">repository</span> [<span class="hljs-number">192.168</span><span class="hljs-number">.48</span><span class="hljs-number">.100</span><span class="hljs-string">/qianyios/nginx</span>]<br><span class="hljs-attr">d874fd2bc83b:</span> <span class="hljs-string">Pushed</span><br><span class="hljs-attr">32ce5f6a5106:</span> <span class="hljs-string">Pushed</span><br><span class="hljs-attr">f1db227348d0:</span> <span class="hljs-string">Pushed</span><br><span class="hljs-attr">b8d6e692a25e:</span> <span class="hljs-string">Pushed</span><br><span class="hljs-attr">e379e8aedd4d:</span> <span class="hljs-string">Pushed</span><br><span class="hljs-attr">2edcec3590a4:</span> <span class="hljs-string">Pushed</span><br><span class="hljs-attr">V1: digest: sha256:ee89b00528ff4f02f2405e4ee221743ebc3f8e8dd0bfd5c4c20a2fa2aaa7ede3 size:</span> <span class="hljs-number">1570</span><br><span class="hljs-comment">#去页面查看</span><br></code></pre></td></tr></table></figure>

<p><img src="/../img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/6d7f7235d5636f60c30ab7d54aad2495697559838-1728463576637-14.png" srcset="/img/loading.gif" lazyload alt="image-20240430181509733"></p>
<p><img src="/../img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/ae31b468f39de92e7d063b51cc927f60697559838-1728463576637-15.png" srcset="/img/loading.gif" lazyload alt="image-20240430181528902"></p>
<p>我们去harbor1测试拉取镜像，会发现下载数变成了<code>1</code></p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs makefile">[root@harbor1 ~]<span class="hljs-comment"># docker pull 192.168.48.100/qianyios/nginx:V1</span><br><span class="hljs-section">V1: Pulling from qianyios/nginx</span><br><span class="hljs-section">a2abf6c4d29d: Pull complete</span><br><span class="hljs-section">a9edb18cadd1: Pull complete</span><br><span class="hljs-section">589b7251471a: Pull complete</span><br><span class="hljs-section">186b1aaa4aa6: Pull complete</span><br><span class="hljs-section">b4df32aa5a72: Pull complete</span><br><span class="hljs-section">a0bcbecc962e: Pull complete</span><br><span class="hljs-section">Digest: sha256:ee89b00528ff4f02f2405e4ee221743ebc3f8e8dd0bfd5c4c20a2fa2aaa7ede3</span><br><span class="hljs-section">Status: Downloaded newer image for 192.168.48.100/qianyios/nginx:V1</span><br><span class="hljs-section">192.168.48.100/qianyios/nginx:V1</span><br>[root@harbor1 ~]<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>

<p><img src="/../img/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/278420fe109835fc53650493f984675c697559838-1728463576638-16.png" srcset="/img/loading.gif" lazyload alt="image-20240430181626605"></p>
<div class="tbsm" style="margin-top:54px;">
<div class="tbsm-top"><span><svg t="1674654360507" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="987" data-spm-anchor-id="a313x.7781069.0.i0" width="35" height="35"><path d="M410.49 97.74H155.08a56.74 56.74 0 0 0-56.84 56.73V410a56.84 56.84 0 0 0 56.84 56.84h255.41A56.83 56.83 0 0 0 467.32 410V154.58a56.83 56.83 0 0 0-56.83-56.84zM410.49 558.74H155.08a56.74 56.74 0 0 0-56.84 56.73V871a56.84 56.84 0 0 0 56.84 56.84h255.41A56.83 56.83 0 0 0 467.32 871V615.58a56.83 56.83 0 0 0-56.83-56.84zM871.49 558.74H616.08a56.74 56.74 0 0 0-56.84 56.73V871a56.84 56.84 0 0 0 56.84 56.84h255.41A56.83 56.83 0 0 0 928.32 871V615.58a56.83 56.83 0 0 0-56.83-56.84z" fill="#66EEFF" p-id="988"></path><path d="M410.49 558.74h-4.14A475 475 0 0 0 299.52 859.6a481.16 481.16 0 0 0 4.84 68.22h106.13A56.83 56.83 0 0 0 467.32 871V615.58a56.83 56.83 0 0 0-56.83-56.84zM871.49 558.74H616.08a56.74 56.74 0 0 0-56.84 56.73V871a56.84 56.84 0 0 0 56.84 56.84h255.41A56.83 56.83 0 0 0 928.32 871V615.58a56.83 56.83 0 0 0-56.83-56.84z" fill="#C2F8FF" p-id="989"></path></svg></span><span style="font-size:30px;"> 特别声明</span></div>
<div class="tbsm-wz">千屹博客旗下的所有文章，是通过本人课堂学习和课外自学所精心整理的知识巨著<br/>难免会有出错的地方<br/>如果细心的你发现了小失误，可以在下方评论区告诉我，或者私信我！<br />非常感谢大家的热烈支持！</div>
</div>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/OpenEuler/">#OpenEuler</a>
      
        <a href="/tags/Harbor/">#Harbor</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Harbor共享存储高可用</div>
      <div>https://blog.qianyios.top/posts/40301/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>严千屹</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年4月30日</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>更新于</div>
          <div>2024年10月9日</div>
        </div>
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
                <a target="_blank" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">
                  <span class="hint--top hint--rounded" aria-label="NC - 非商业性使用">
                    <i class="iconfont icon-nc"></i>
                  </span>
                </a>
              
                <a target="_blank" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">
                  <span class="hint--top hint--rounded" aria-label="ND - 禁止演绎">
                    <i class="iconfont icon-nd"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/posts/40462/" title="基于K8S的CICD系统实现">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">基于K8S的CICD系统实现</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/posts/62904/" title="OpenEuler-K8S高可用集群（内部etcd）">
                        <span class="hidden-mobile">OpenEuler-K8S高可用集群（内部etcd）</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"geJAvpyCyYwmp1wI8u2CCkV5-gzGzoHsz","appKey":"WnNukDH4RUTtMsUwJvNG4vyR","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":true},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <div class="zsqk"> <p>(￣▽￣)" 赞赏！</p> <div class="zstb"> <a  class="qr-trigger" target="_self"> <i class="iconfont icon-wechat-fill" aria-hidden="true"></i> <img class="qr-img animate__animated animate__bounc animate__fadeInDown" src="https://blog.qianyios.top/img/zansang/wxzf.png" srcset="/img/loading.gif" lazyload alt="qrcode" /> </a> <a  class="qr-trigger" target="_self"> <i class="iconfont icon-alipay-fill" aria-hidden="true"></i> <img class="qr-img animate__animated animate__bounc animate__fadeInDown" src="https://blog.qianyios.top/img/zansang/zfb.png" srcset="/img/loading.gif" lazyload alt="qrcode" /> </a>
</div>
<p class="zsyy animate__animated animate__bounce animate__flash animate__infinite	infinite animate__slow">如果对你有帮助，就请我喝一杯吧！！</p> </div> <br /> <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
    <!-- 备案信息 ICP for China -->
    <div class="beian">
  <span>
    <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
     ICP备案号: 粤ICP备2024250479号-1
    </a>
  </span>
</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
