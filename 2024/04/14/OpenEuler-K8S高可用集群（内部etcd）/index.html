

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>
<head>
  <script async src="https://us.umami.is/script.js" data-website-id="83039d8f-bd3d-4637-bcfa-22c3a2fc0ac1"></script>

<meta name="generator" content="Hexo 6.3.0"></head>


<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#9ce8f452">
  <meta name="author" content="严千屹">
  <meta name="keywords" content="">
  
    <meta name="description" content="基于华为欧拉系统的K8s高可用集群">
<meta property="og:type" content="article">
<meta property="og:title" content="OpenEuler-部署K8S高可用集群（内部etcd）">
<meta property="og:url" content="https://blog.qianyios.top/2024/04/14/OpenEuler-K8S%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%EF%BC%88%E5%86%85%E9%83%A8etcd%EF%BC%89/index.html">
<meta property="og:site_name" content="严千屹博客">
<meta property="og:description" content="基于华为欧拉系统的K8s高可用集群">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog.qianyios.top/img/OpenEuler-K8S%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%EF%BC%88%E5%86%85%E9%83%A8etcd%EF%BC%89/Snipaste_2024-04-14_15-02-09.png">
<meta property="article:published_time" content="2024-04-14T15:09:40.000Z">
<meta property="article:modified_time" content="2024-04-15T14:06:57.712Z">
<meta property="article:author" content="严千屹">
<meta property="article:tag" content="K8s">
<meta property="article:tag" content="OpenEuler">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog.qianyios.top/img/OpenEuler-K8S%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%EF%BC%88%E5%86%85%E9%83%A8etcd%EF%BC%89/Snipaste_2024-04-14_15-02-09.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>OpenEuler-部署K8S高可用集群（内部etcd） - 严千屹博客</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/mycss.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"blog.qianyios.top","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":true,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  <meta name="referrer" content="no-referrer"/>

  
</head>

<link rel="stylesheet" href="https://portb.kbai.cc/hexo&kbai/mousezhizhen.css"/>
<canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 9999; pointer-events: none;" ></canvas>
<script src="https://cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script>
<script src="https://script-1256884783.file.myqcloud.com/cursor/explosion.min.js"></script>
<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>严 千 屹</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/null') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="OpenEuler-部署K8S高可用集群（内部etcd）"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-04-14 15:09" pubdate>
          2024年4月14日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          28k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          234 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">OpenEuler-部署K8S高可用集群（内部etcd）</h1>
            
            
              <div class="markdown-body">
                
                <meta name="referrer" content="no-referrer"/>

<h1 id="OpenEuler-部署K8S高可用集群（内部etcd）"><a href="#OpenEuler-部署K8S高可用集群（内部etcd）" class="headerlink" title="OpenEuler-部署K8S高可用集群（内部etcd）"></a>OpenEuler-部署K8S高可用集群（内部etcd）</h1><h2 id="主机拓扑"><a href="#主机拓扑" class="headerlink" title="主机拓扑"></a>主机拓扑</h2><table>
<thead>
<tr>
<th>主机名</th>
<th>ip1（NAT）</th>
<th>系统</th>
<th>磁盘</th>
<th>内存</th>
</tr>
</thead>
<tbody><tr>
<td>master1</td>
<td>192.168.48.101</td>
<td>OpenEuler-22.03-LTS</td>
<td>100G</td>
<td>4G</td>
</tr>
<tr>
<td>master2</td>
<td>192.168.48.102</td>
<td>OpenEuler-22.03-LTS</td>
<td>100G</td>
<td>4G</td>
</tr>
<tr>
<td>master3</td>
<td>192.168.48.103</td>
<td>OpenEuler-22.03-LTS</td>
<td>100G</td>
<td>4G</td>
</tr>
<tr>
<td>node01</td>
<td>192.168.48.104</td>
<td>OpenEuler-22.03-LTS</td>
<td>100G</td>
<td>8G</td>
</tr>
</tbody></table>
<h2 id="基础配置"><a href="#基础配置" class="headerlink" title="基础配置"></a>基础配置</h2><p>Openeuler通过单独安装，非克隆。安装完后进行基本环境的配置，配置一下几个方面：</p>
<ol>
<li>设置主机名</li>
<li>关闭firewalld、dnsmasq、selinux</li>
<li>设置ens160</li>
<li>优化ssh</li>
<li>备份并新增、docker-ce源、k8s源</li>
<li>更新yum源软件包缓存</li>
<li>修改history格式及记录数</li>
<li>添加hosts解析</li>
<li>关闭swap分区</li>
<li>安装chrony服务，并同步时间</li>
<li>配置limits.conf</li>
<li>安装必备工具</li>
<li>升级系统并重启</li>
</ol>
<p>操作主机：[master1,master2,master3,node01]</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#将以下脚本内容添加进去</span><br><span class="hljs-attribute">vi</span> k8s_system_init.sh<br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-variable">$#</span> -eq <span class="hljs-number">2</span> ];then<br>  echo <span class="hljs-string">&quot;设置主机名为：$1&quot;</span><br>  echo <span class="hljs-string">&quot;ens160设置IP地址为：192.168.48.$2&quot;</span><br><span class="hljs-keyword">else</span><br>  echo  <span class="hljs-string">&quot;使用方法：sh $0 主机名 主机位&quot;</span><br>  <span class="hljs-keyword">exit</span> <span class="hljs-number">2</span><br>fi<br><br>echo <span class="hljs-string">&quot;--------------------------------------&quot;</span><br>echo <span class="hljs-string">&quot;1.正在设置主机名：$1&quot;</span><br>hostnamectl set-hostname <span class="hljs-variable">$1</span><br><br>echo <span class="hljs-string">&quot;2.正在关闭firewalld、dnsmasq、selinux&quot;</span><br>systemctl disable firewalld &amp;&gt; <span class="hljs-regexp">/dev/</span>null<br>systemctl disable dnsmasq &amp;&gt; <span class="hljs-regexp">/dev/</span>null<br>systemctl stop firewalld<br>systemctl stop dnsmasq<br>sed -i <span class="hljs-string">&quot;s#SELINUX=enforcing#SELINUX=disabled#g&quot;</span> <span class="hljs-regexp">/etc/</span>selinux/config<br>setenforce <span class="hljs-number">0</span><br><br><br>echo <span class="hljs-string">&quot;3.正在设置ens160：192.168.48.$2&quot;</span><br>cat &gt; <span class="hljs-regexp">/etc/</span>sysconfig<span class="hljs-regexp">/network-scripts/i</span>fcfg-ens160 &lt;&lt;EOF<br>TYPE=Ethernet<br>PROXY_METHOD=none<br>BROWSER_ONLY=no<br>BOOTPROTO=static<br>DEFROUTE=yes<br>IPV4_FAILURE_FATAL=no<br>IPV6INIT=yes<br>IPV6_AUTOCONF=yes<br>IPV6_DEFROUTE=yes<br>IPV6_FAILURE_FATAL=no<br>NAME=ens160<br>UUID=<span class="hljs-number">53</span>b402ff-<span class="hljs-number">5865</span>-<span class="hljs-number">47</span>dd-a853-<span class="hljs-number">7</span>afcd6521738<br>DEVICE=ens160<br>ONBOOT=yes<br>IPADDR=<span class="hljs-number">192.168</span>.<span class="hljs-number">48</span>.<span class="hljs-variable">$2</span><br>GATEWAY=<span class="hljs-number">192.168</span>.<span class="hljs-number">48.2</span><br>PREFIX=<span class="hljs-number">24</span><br>DNS1=<span class="hljs-number">192.168</span>.<span class="hljs-number">48.2</span><br>DNS2=<span class="hljs-number">114.114</span>.<span class="hljs-number">114.114</span><br><br>nmcli c reload<br>nmcli c up ens <span class="hljs-number">160</span><br><br><br>echo <span class="hljs-string">&quot;4.优化ssh&quot;</span><br>sed -i <span class="hljs-string">&quot;s#\#UseDNS yes#UseDNS no#g&quot;</span> <span class="hljs-regexp">/etc/</span>ssh/sshd_config<br>sed -i <span class="hljs-string">&quot;s#GSSAPIAuthentication yes#GSSAPIAuthentication no#g&quot;</span> <span class="hljs-regexp">/etc/</span>ssh/sshd_config<br>systemctl restart sshd<br><br>echo <span class="hljs-string">&quot;5.新增docker-ce源、k8s源&quot;</span><br>mkdir <span class="hljs-regexp">/etc/yum</span>.repos.d<span class="hljs-regexp">/bak/</span><br>cp <span class="hljs-regexp">/etc/yum</span>.repos.d<span class="hljs-regexp">/* /</span>etc<span class="hljs-regexp">/yum.repos.d/</span>bak/<br>cat &gt; <span class="hljs-regexp">/etc/yum</span>.repos.d/kubernetes.repo &lt;&lt;EOF<br>[kubernetes]<br>name=Kubernetes<br>baseurl=https:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/kubernetes/yum</span><span class="hljs-regexp">/repos/</span>kubernetes-el7-x86_64/<br>enabled=<span class="hljs-number">1</span><br>gpgcheck=<span class="hljs-number">0</span><br>repo_gpgcheck=<span class="hljs-number">0</span><br>gpgkey=https:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/kubernetes/yum</span><span class="hljs-regexp">/doc/yum</span>-key.gpg <br>EOF<br><br>curl -o <span class="hljs-regexp">/etc/yum</span>.repos.d<span class="hljs-regexp">/docker-ce.repo https:/</span><span class="hljs-regexp">/mirrors.aliyun.com/</span>docker-ce<span class="hljs-regexp">/linux/</span>centos/docker-ce.repo<br>sed -i <span class="hljs-string">&#x27;s/\$releasever/7/g&#x27;</span> <span class="hljs-regexp">/etc/yum</span>.repos.d/docker-ce.repo<br><br>echo <span class="hljs-string">&quot;6.更新yum源软件包缓存&quot;</span><br> yum clean all &amp;&amp; yum makecache<br><br><br>echo <span class="hljs-string">&quot;7.修改history格式及记录数&quot;</span><br>sed -i <span class="hljs-string">&quot;s#HISTSIZE=1000##g&quot;</span> <span class="hljs-regexp">/etc/</span>profile<br>cat &gt;&gt; <span class="hljs-regexp">/etc/</span>profile &lt;&lt;EOF<br>shopt -s histappend<br>USER_IP=`who -u am i <span class="hljs-number">2</span>&gt;<span class="hljs-regexp">/dev/</span>null| awk <span class="hljs-string">&#x27;&#123;print $NF&#125;&#x27;</span>|sed -e <span class="hljs-string">&#x27;s/[()]//g&#x27;</span>`<br>export HISTFILE=~/.commandline_warrior<br>export HISTTIMEFORMAT=<span class="hljs-string">&quot;%Y-%m-%d %H:%M:%S  `whoami`@$&#123;USER_IP&#125;: &quot;</span><br>export HISTSIZE=<span class="hljs-number">200000</span><br>export HISTFILESIZE=<span class="hljs-number">1000000</span><br>export PROMPT_COMMAND=<span class="hljs-string">&quot;history -a&quot;</span><br>EOF<br>source <span class="hljs-regexp">/etc/</span>profile<br><br><br>echo <span class="hljs-string">&quot;8.添加hosts解析&quot;</span><br>cat &gt; <span class="hljs-regexp">/etc/</span>hosts &lt;&lt;EOF<br><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>   localhost localhost.localdomain localhost4 localhost4.localdomain4<br>::<span class="hljs-number">1</span>         localhost localhost.localdomain localhost6 localhost6.localdomain6<br><span class="hljs-number">192.168</span>.<span class="hljs-number">48.101</span> master1<br><span class="hljs-number">192.168</span>.<span class="hljs-number">48.102</span> master2<br><span class="hljs-number">192.168</span>.<span class="hljs-number">48.103</span> master3<br><span class="hljs-number">192.168</span>.<span class="hljs-number">48.104</span> node01<br><span class="hljs-number">192.168</span>.<span class="hljs-number">48.105</span> node02<br>EOF<br><br><br>echo <span class="hljs-string">&quot;9.关闭swap分区&quot;</span><br>swapoff -a &amp;&amp; sysctl -w vm.swappiness=<span class="hljs-number">0</span> &amp;&gt; <span class="hljs-regexp">/dev/</span>null<br>sed -ri <span class="hljs-string">&#x27;/^[^#]*swap/s@^@#@&#x27;</span> <span class="hljs-regexp">/etc/</span>fstab<br><br><br>echo <span class="hljs-string">&quot;10.安装chrony服务，并同步时间&quot;</span><br>yum install chrony -y<br>systemctl start chronyd<br>systemctl enable chronyd<br>chronyc sources<br>chronyc sources<br><br>echo <span class="hljs-string">&quot;11.配置limits.conf&quot;</span><br>ulimit -SHn <span class="hljs-number">65535</span><br>cat &gt;&gt; <span class="hljs-regexp">/etc/</span>security/limits.conf &lt;&lt;EOF<br>* soft nofile <span class="hljs-number">65536</span><br>* hard nofile <span class="hljs-number">131072</span><br>* soft nproc <span class="hljs-number">65535</span><br>* hard nproc <span class="hljs-number">655350</span><br>* soft memlock unlimited<br>* hard memlock unlimited<br>EOF<br><br><br>echo <span class="hljs-string">&quot;12.必备工具安装&quot;</span><br>yum install wget psmisc vim net-tools telnet device-mapper-persistent-data lvm2 git -y<br><br><br>echo <span class="hljs-string">&quot;13.升级系统并重启&quot;</span><br>yum update -y --exclude=kernel* &amp;&amp; reboot<br><br></code></pre></td></tr></table></figure>

<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">sh </span>k8s_system_init.<span class="hljs-keyword">sh </span>主机名 主机位<br>[master1] <span class="hljs-keyword">sh </span>k8s_system_init.<span class="hljs-keyword">sh </span>master1 <span class="hljs-number">101</span><br><br>[master2] <span class="hljs-keyword">sh </span>k8s_system_init.<span class="hljs-keyword">sh </span>master2 <span class="hljs-number">102</span><br><br>[master3] <span class="hljs-keyword">sh </span>k8s_system_init.<span class="hljs-keyword">sh </span>master3 <span class="hljs-number">103</span><br><br>[node01] <span class="hljs-keyword">sh </span>k8s_system_init.<span class="hljs-keyword">sh </span>node01 <span class="hljs-number">104</span><br><br></code></pre></td></tr></table></figure>

<h3 id="配置ssh免密"><a href="#配置ssh免密" class="headerlink" title="配置ssh免密"></a>配置ssh免密</h3><p>操作节点[master1]</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum install -y sshpass <br><span class="hljs-built_in">cat</span> &gt; sshmianmi.sh &lt;&lt; <span class="hljs-string">&quot;EOF&quot;</span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment"># 目标主机列表</span><br>hosts=(<span class="hljs-string">&quot;master1&quot;</span> <span class="hljs-string">&quot;master2&quot;</span> <span class="hljs-string">&quot;master3&quot;</span> <span class="hljs-string">&quot;node01&quot;</span>)<br><span class="hljs-comment"># 密码</span><br>password=<span class="hljs-string">&quot;Lj201840.&quot;</span><br><span class="hljs-comment"># 生成 SSH 密钥对</span><br>ssh-keygen -t rsa -N <span class="hljs-string">&quot;&quot;</span> -f ~/.ssh/id_rsa<br><br><span class="hljs-comment"># 循环遍历目标主机</span><br><span class="hljs-keyword">for</span> host <span class="hljs-keyword">in</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;hosts[@]&#125;</span>&quot;</span><br><span class="hljs-keyword">do</span><br>    <span class="hljs-comment"># 复制公钥到目标主机</span><br>    sshpass -p <span class="hljs-string">&quot;<span class="hljs-variable">$password</span>&quot;</span> ssh-copy-id -o StrictHostKeyChecking=no <span class="hljs-string">&quot;<span class="hljs-variable">$host</span>&quot;</span><br>    <br>    <span class="hljs-comment"># 验证免密登录</span><br>    sshpass -p <span class="hljs-string">&quot;<span class="hljs-variable">$password</span>&quot;</span> ssh -o StrictHostKeyChecking=no <span class="hljs-string">&quot;<span class="hljs-variable">$host</span>&quot;</span> <span class="hljs-string">&quot;echo &#x27;免密登录成功&#x27;&quot;</span><br><span class="hljs-keyword">done</span><br>EOF<br><br>sh sshmianmi.sh<br></code></pre></td></tr></table></figure>

<h2 id="内核及ipvs模块配置"><a href="#内核及ipvs模块配置" class="headerlink" title="内核及ipvs模块配置"></a>内核及ipvs模块配置</h2><p>此步骤是配置ipvs模块，开启一些k8s集群中必须的内核参数。配置一下几个方面：</p>
<ol>
<li>更改内核启动顺序</li>
<li>安装ipvsadm</li>
<li>配置ipvs模块</li>
<li>开启k8s集群必须的内核参数</li>
<li>配置完内核，重启服务器</li>
</ol>
<p>操作主机：[master1,master2,master3,node01]</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">vi</span> kernel_update.<span class="hljs-keyword">sh</span><br></code></pre></td></tr></table></figure>

<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs stylus">#!/bin/bash<br><br>echo <span class="hljs-string">&quot;1.更改内核启动顺序&quot;</span><br>grub2-set-default  <span class="hljs-number">0</span> &amp;&amp; grub2-mkconfig -o /etc/grub2<span class="hljs-selector-class">.cfg</span><br>grubby <span class="hljs-attr">--args</span>=<span class="hljs-string">&quot;user_namespace.enable=1&quot;</span> <span class="hljs-attr">--update-kernel</span>=<span class="hljs-string">&quot;$(grubby --default-kernel)&quot;</span><br><br>echo <span class="hljs-string">&quot;2.安装ipvsadm&quot;</span><br>yum install ipvsadm ipset sysstat conntrack libseccomp -y &amp;&gt; /dev/null<br><br><br>echo <span class="hljs-string">&quot;3.配置ipvs模块&quot;</span><br>modprobe -- ip_vs<br>modprobe -- ip_vs_rr<br>modprobe -- ip_vs_wrr<br>modprobe -- ip_vs_sh<br>modprobe -- nf_conntrack<br><br>cat &gt;&gt; /etc/modules-load.d/ipvs<span class="hljs-selector-class">.conf</span> &lt;&lt;EOF<br>ip_vs<br>ip_vs_lc<br>ip_vs_wlc<br>ip_vs_rr<br>ip_vs_wrr<br>ip_vs_lblc<br>ip_vs_lblcr<br>ip_vs_dh<br>ip_vs_sh<br>ip_vs_fo<br>ip_vs_nq<br>ip_vs_sed<br>ip_vs_ftp<br>ip_vs_sh<br>nf_conntrack<br>ip_tables<br>ip_set<br>xt_set<br>ipt_set<br>ipt_rpfilter<br>ipt_REJECT<br>ipip<br>EOF<br>systemctl enable <span class="hljs-attr">--now</span> systemd-modules-load<span class="hljs-selector-class">.service</span> &amp;&gt; /dev/null<br><br><br>echo <span class="hljs-string">&quot;4.开启k8s集群必须的内核参数&quot;</span><br>cat &lt;&lt;EOF &gt; /etc/sysctl.d/k8s<span class="hljs-selector-class">.conf</span><br>net<span class="hljs-selector-class">.ipv4</span><span class="hljs-selector-class">.ip_forward</span> = <span class="hljs-number">1</span><br>net<span class="hljs-selector-class">.bridge</span><span class="hljs-selector-class">.bridge-nf-call-iptables</span> = <span class="hljs-number">1</span><br>net<span class="hljs-selector-class">.bridge</span><span class="hljs-selector-class">.bridge-nf-call-ip6tables</span> = <span class="hljs-number">1</span><br>fs<span class="hljs-selector-class">.may_detach_mounts</span> = <span class="hljs-number">1</span><br>net<span class="hljs-selector-class">.ipv4</span><span class="hljs-selector-class">.conf</span><span class="hljs-selector-class">.all</span><span class="hljs-selector-class">.route_localnet</span> = <span class="hljs-number">1</span><br>vm.overcommit_memory=<span class="hljs-number">1</span><br>vm.panic_on_oom=<span class="hljs-number">0</span><br>fs<span class="hljs-selector-class">.inotify</span>.max_user_watches=<span class="hljs-number">89100</span><br>fs.file-max=<span class="hljs-number">52706963</span><br>fs.nr_open=<span class="hljs-number">52706963</span><br>net<span class="hljs-selector-class">.netfilter</span>.nf_conntrack_max=<span class="hljs-number">2310720</span><br><br>net<span class="hljs-selector-class">.ipv4</span><span class="hljs-selector-class">.tcp_keepalive_time</span> = <span class="hljs-number">600</span><br>net<span class="hljs-selector-class">.ipv4</span><span class="hljs-selector-class">.tcp_keepalive_probes</span> = <span class="hljs-number">3</span><br>net<span class="hljs-selector-class">.ipv4</span><span class="hljs-selector-class">.tcp_keepalive_intvl</span> =<span class="hljs-number">15</span><br>net<span class="hljs-selector-class">.ipv4</span><span class="hljs-selector-class">.tcp_max_tw_buckets</span> = <span class="hljs-number">36000</span><br>net<span class="hljs-selector-class">.ipv4</span><span class="hljs-selector-class">.tcp_tw_reuse</span> = <span class="hljs-number">1</span><br>net<span class="hljs-selector-class">.ipv4</span><span class="hljs-selector-class">.tcp_max_orphans</span> = <span class="hljs-number">327680</span><br>net<span class="hljs-selector-class">.ipv4</span><span class="hljs-selector-class">.tcp_orphan_retries</span> = <span class="hljs-number">3</span><br>net<span class="hljs-selector-class">.ipv4</span><span class="hljs-selector-class">.tcp_syncookies</span> = <span class="hljs-number">1</span><br>net<span class="hljs-selector-class">.ipv4</span><span class="hljs-selector-class">.tcp_max_syn_backlog</span> = <span class="hljs-number">16384</span><br>net<span class="hljs-selector-class">.ipv4</span><span class="hljs-selector-class">.ip_conntrack_max</span> = <span class="hljs-number">65536</span><br>net<span class="hljs-selector-class">.ipv4</span><span class="hljs-selector-class">.tcp_max_syn_backlog</span> = <span class="hljs-number">16384</span><br>net<span class="hljs-selector-class">.ipv4</span><span class="hljs-selector-class">.tcp_timestamps</span> = <span class="hljs-number">0</span><br>net<span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.somaxconn</span> = <span class="hljs-number">16384</span><br>EOF<br>sysctl <span class="hljs-attr">--system</span><br><br><br>echo <span class="hljs-string">&quot;5.配置完内核，重启服务器！&quot;</span><br>reboot<br><br></code></pre></td></tr></table></figure>

<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-keyword">sh</span> kernel_update.<span class="hljs-keyword">sh</span><br></code></pre></td></tr></table></figure>

<h2 id="检查ipvs加载、内核版本验证"><a href="#检查ipvs加载、内核版本验证" class="headerlink" title="检查ipvs加载、内核版本验证"></a>检查ipvs加载、内核版本验证</h2><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs coq">lsmod | <span class="hljs-type">grep</span> --color=<span class="hljs-built_in">auto</span> -e ip_vs -e nf_conntrack<br>uname -a<br></code></pre></td></tr></table></figure>

<p><img src="/../img/OpenEuler-K8S%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%EF%BC%88%E5%86%85%E9%83%A8etcd%EF%BC%89/35e8628e15d1886815b77e7ef1cfd352697559838.png" srcset="/img/loading.gif" lazyload alt="image-20231201233238841"></p>
<h2 id="高可用组件安装"><a href="#高可用组件安装" class="headerlink" title="高可用组件安装"></a>高可用组件安装</h2><h3 id="haproxy配置"><a href="#haproxy配置" class="headerlink" title="haproxy配置"></a>haproxy配置</h3><p>操作节点：[master1，master2,master3]</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmake">yum <span class="hljs-keyword">install</span> keepalived haproxy -y<br></code></pre></td></tr></table></figure>

<p>所有Master节点配置HAProxy，所有Master节点的HAProxy配置相同。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">操作节点：[master1，master2,</span> <span class="hljs-string">master3]</span><br><span class="hljs-string">cat</span> <span class="hljs-string">&gt;</span> <span class="hljs-string">/etc/haproxy/haproxy.cfg</span> <span class="hljs-string">&lt;&lt;&quot;EOF&quot;</span><br><br><span class="hljs-string">global</span><br>  <span class="hljs-string">maxconn</span>  <span class="hljs-number">2000</span><br>  <span class="hljs-string">ulimit-n</span>  <span class="hljs-number">16384</span><br>  <span class="hljs-string">log</span>  <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> <span class="hljs-string">local0</span> <span class="hljs-string">err</span><br>  <span class="hljs-string">stats</span> <span class="hljs-string">timeout</span> <span class="hljs-string">30s</span><br><br><span class="hljs-string">defaults</span><br>  <span class="hljs-string">log</span> <span class="hljs-string">global</span><br>  <span class="hljs-string">mode</span>  <span class="hljs-string">http</span><br>  <span class="hljs-string">option</span>  <span class="hljs-string">httplog</span><br>  <span class="hljs-string">timeout</span> <span class="hljs-string">connect</span> <span class="hljs-number">5000</span><br>  <span class="hljs-string">timeout</span> <span class="hljs-string">client</span>  <span class="hljs-number">50000</span><br>  <span class="hljs-string">timeout</span> <span class="hljs-string">server</span>  <span class="hljs-number">50000</span><br>  <span class="hljs-string">timeout</span> <span class="hljs-string">http-request</span> <span class="hljs-string">15s</span><br>  <span class="hljs-string">timeout</span> <span class="hljs-string">http-keep-alive</span> <span class="hljs-string">15s</span><br><br><span class="hljs-string">frontend</span> <span class="hljs-string">monitor-in</span><br>  <span class="hljs-string">bind</span> <span class="hljs-string">*:33305</span><br>  <span class="hljs-string">mode</span> <span class="hljs-string">http</span><br>  <span class="hljs-string">option</span> <span class="hljs-string">httplog</span><br>  <span class="hljs-string">monitor-uri</span> <span class="hljs-string">/monitor</span><br><br><span class="hljs-string">frontend</span> <span class="hljs-string">k8s-master</span><br>  <span class="hljs-string">bind</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-string">:16443</span><br>  <span class="hljs-string">bind</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:16443</span><br>  <span class="hljs-string">mode</span> <span class="hljs-string">tcp</span><br>  <span class="hljs-string">option</span> <span class="hljs-string">tcplog</span><br>  <span class="hljs-string">tcp-request</span> <span class="hljs-string">inspect-delay</span> <span class="hljs-string">5s</span><br>  <span class="hljs-string">default_backend</span> <span class="hljs-string">k8s-master</span><br><br><span class="hljs-string">backend</span> <span class="hljs-string">k8s-master</span><br>  <span class="hljs-string">mode</span> <span class="hljs-string">tcp</span><br>  <span class="hljs-string">option</span> <span class="hljs-string">tcplog</span><br>  <span class="hljs-string">option</span> <span class="hljs-string">tcp-check</span><br>  <span class="hljs-string">balance</span> <span class="hljs-string">roundrobin</span><br>  <span class="hljs-string">default-server</span> <span class="hljs-string">inter</span> <span class="hljs-string">10s</span> <span class="hljs-string">downinter</span> <span class="hljs-string">5s</span> <span class="hljs-string">rise</span> <span class="hljs-number">2</span> <span class="hljs-string">fall</span> <span class="hljs-number">2</span> <span class="hljs-string">slowstart</span> <span class="hljs-string">60s</span> <span class="hljs-string">maxconn</span> <span class="hljs-number">250</span> <span class="hljs-string">maxqueue</span> <span class="hljs-number">256</span> <span class="hljs-string">weight</span> <span class="hljs-number">100</span><br>  <span class="hljs-string">server</span> <span class="hljs-string">master1</span>   <span class="hljs-number">192.168</span><span class="hljs-number">.48</span><span class="hljs-number">.101</span><span class="hljs-string">:6443</span>  <span class="hljs-string">check</span><br>  <span class="hljs-string">server</span> <span class="hljs-string">master2</span>   <span class="hljs-number">192.168</span><span class="hljs-number">.48</span><span class="hljs-number">.102</span><span class="hljs-string">:6443</span>  <span class="hljs-string">check</span><br>  <span class="hljs-string">server</span> <span class="hljs-string">master3</span>   <span class="hljs-number">192.168</span><span class="hljs-number">.48</span><span class="hljs-number">.103</span><span class="hljs-string">:6443</span>  <span class="hljs-string">check</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure>

<h3 id="Keepalived配置"><a href="#Keepalived配置" class="headerlink" title="Keepalived配置"></a>Keepalived配置</h3><p>操作节点：[master1，master2,master3]</p>
<p>所有Master节点配置Keepalived，以下三个Master节点配置注意ip和网卡。</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs fsharp">操作节点：[master1]<br><br>cat <span class="hljs-operator">&gt;/</span>etc<span class="hljs-operator">/</span>keepalived<span class="hljs-operator">/</span>keepalived.conf  <span class="hljs-operator">&lt;&lt;</span><span class="hljs-string">&quot;EOF&quot;</span><br><br><span class="hljs-operator">!</span> Configuration File <span class="hljs-keyword">for</span> keepalived<br><span class="hljs-keyword">global_defs</span> &#123;<br>    router_id LVS_DEVEL<br>script_user root<br>    enable_script_security<br>&#125;<br>vrrp_script <span class="hljs-keyword">chk_apiserver</span> &#123;<br>    script <span class="hljs-string">&quot;/etc/keepalived/check_apiserver.sh&quot;</span><br>    interval <span class="hljs-number">5</span><br>    weight <span class="hljs-number">-5</span><br>    fall <span class="hljs-number">2</span>  <br>rise <span class="hljs-number">1</span><br>&#125;<br>vrrp_instance VI_1 &#123;<br>    state MASTER<br>    <span class="hljs-keyword">interface</span> ens160<br>    mcast_src_ip <span class="hljs-number">192.168</span><span class="hljs-number">.48</span><span class="hljs-number">.101</span><br>    virtual_router_id <span class="hljs-number">51</span><br>    priority <span class="hljs-number">101</span><br>    advert_int <span class="hljs-number">2</span><br>    <span class="hljs-keyword">authentication</span> &#123;<br>        auth_type PASS<br>        auth_pass K8SHA_KA_AUTH<br>    &#125;<br>    <span class="hljs-keyword">virtual_ipaddress</span> &#123;<br>        <span class="hljs-number">192.168</span><span class="hljs-number">.48</span><span class="hljs-number">.200</span><br>    &#125;<br>    <span class="hljs-keyword">track_script</span> &#123;<br>       chk_apiserver<br>    &#125;<br>&#125;<br>EOF<br></code></pre></td></tr></table></figure>

<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs fsharp">操作节点：[master2]<br>cat <span class="hljs-operator">&gt;/</span>etc<span class="hljs-operator">/</span>keepalived<span class="hljs-operator">/</span>keepalived.conf  <span class="hljs-operator">&lt;&lt;</span><span class="hljs-string">&quot;EOF&quot;</span><br><br><span class="hljs-operator">!</span> Configuration File <span class="hljs-keyword">for</span> keepalived<br><span class="hljs-keyword">global_defs</span> &#123;<br>    router_id LVS_DEVEL<br>script_user root<br>    enable_script_security<br>&#125;<br>vrrp_script <span class="hljs-keyword">chk_apiserver</span> &#123;<br>    script <span class="hljs-string">&quot;/etc/keepalived/check_apiserver.sh&quot;</span><br>    interval <span class="hljs-number">5</span><br>    weight <span class="hljs-number">-5</span><br>    fall <span class="hljs-number">2</span>  <br>rise <span class="hljs-number">1</span><br>&#125;<br>vrrp_instance VI_1 &#123;<br>    state BACKUP<br>    <span class="hljs-keyword">interface</span> ens160<br>    mcast_src_ip <span class="hljs-number">192.168</span><span class="hljs-number">.48</span><span class="hljs-number">.102</span><br>    virtual_router_id <span class="hljs-number">51</span><br>    priority <span class="hljs-number">100</span><br>    advert_int <span class="hljs-number">2</span><br>    <span class="hljs-keyword">authentication</span> &#123;<br>        auth_type PASS<br>        auth_pass K8SHA_KA_AUTH<br>    &#125;<br>    <span class="hljs-keyword">virtual_ipaddress</span> &#123;<br>        <span class="hljs-number">192.168</span><span class="hljs-number">.48</span><span class="hljs-number">.200</span><br>    &#125;<br>    <span class="hljs-keyword">track_script</span> &#123;<br>       chk_apiserver<br>    &#125;<br>&#125;<br>EOF<br></code></pre></td></tr></table></figure>

<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs fsharp">操作节点：[master3]<br>cat <span class="hljs-operator">&gt;/</span>etc<span class="hljs-operator">/</span>keepalived<span class="hljs-operator">/</span>keepalived.conf  <span class="hljs-operator">&lt;&lt;</span><span class="hljs-string">&quot;EOF&quot;</span><br><br><span class="hljs-operator">!</span> Configuration File <span class="hljs-keyword">for</span> keepalived<br><span class="hljs-keyword">global_defs</span> &#123;<br>    router_id LVS_DEVEL<br>script_user root<br>    enable_script_security<br>&#125;<br>vrrp_script <span class="hljs-keyword">chk_apiserver</span> &#123;<br>    script <span class="hljs-string">&quot;/etc/keepalived/check_apiserver.sh&quot;</span><br>    interval <span class="hljs-number">5</span><br>    weight <span class="hljs-number">-5</span><br>    fall <span class="hljs-number">2</span>  <br>rise <span class="hljs-number">1</span><br>&#125;<br>vrrp_instance VI_1 &#123;<br>    state BACKUP<br>    <span class="hljs-keyword">interface</span> ens160<br>    mcast_src_ip <span class="hljs-number">192.168</span><span class="hljs-number">.48</span><span class="hljs-number">.103</span><br>    virtual_router_id <span class="hljs-number">51</span><br>    priority <span class="hljs-number">99</span><br>    advert_int <span class="hljs-number">2</span><br>    <span class="hljs-keyword">authentication</span> &#123;<br>        auth_type PASS<br>        auth_pass K8SHA_KA_AUTH<br>    &#125;<br>    <span class="hljs-keyword">virtual_ipaddress</span> &#123;<br>        <span class="hljs-number">192.168</span><span class="hljs-number">.48</span><span class="hljs-number">.200</span><br>    &#125;<br>    <span class="hljs-keyword">track_script</span> &#123;<br>       chk_apiserver<br>    &#125;<br>&#125;<br>EOF<br></code></pre></td></tr></table></figure>



<h3 id="配置Keepalived健康检查文件"><a href="#配置Keepalived健康检查文件" class="headerlink" title="配置Keepalived健康检查文件"></a>配置Keepalived健康检查文件</h3><p>操作节点：[master1，master2,master3]</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs awk">cat &gt; <span class="hljs-regexp">/etc/</span>keepalived/check_apiserver.sh &lt;&lt;<span class="hljs-string">&quot;EOF&quot;</span><br> <span class="hljs-comment">#!/bin/bash</span><br> err=<span class="hljs-number">0</span><br> <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> $(seq <span class="hljs-number">1</span> <span class="hljs-number">3</span>)<br> <span class="hljs-keyword">do</span><br>    check_code=$(pgrep haproxy)<br>    <span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$check_code</span> == <span class="hljs-string">&quot;&quot;</span> ]]; then<br>        err=$(expr <span class="hljs-variable">$err</span> + <span class="hljs-number">1</span>)<br>        sleep <span class="hljs-number">1</span><br>        <span class="hljs-keyword">continue</span><br>    <span class="hljs-keyword">else</span><br>        err=<span class="hljs-number">0</span><br>        <span class="hljs-keyword">break</span><br>    fi<br> done<br> <br> <span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$err</span> != <span class="hljs-string">&quot;0&quot;</span> ]]; then<br>    echo <span class="hljs-string">&quot;systemctl stop keepalived&quot;</span><br>    <span class="hljs-regexp">/usr/</span>bin/systemctl stop keepalived<br>    <span class="hljs-keyword">exit</span> <span class="hljs-number">1</span><br> <span class="hljs-keyword">else</span><br>    <span class="hljs-keyword">exit</span> <span class="hljs-number">0</span><br> fi<br>EOF<br><br>chmod +x <span class="hljs-regexp">/etc/</span>keepalived/check_apiserver.sh<br></code></pre></td></tr></table></figure>

<h3 id="启动haproxy和keepalived"><a href="#启动haproxy和keepalived" class="headerlink" title="启动haproxy和keepalived"></a>启动haproxy和keepalived</h3><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">操作节点：[master，master2,master3]<br>systemctl daemon-reload<br>systemctl <span class="hljs-keyword">enable</span> <span class="hljs-comment">--now haproxy</span><br>systemctl <span class="hljs-keyword">enable</span> <span class="hljs-comment">--now keepalived</span><br></code></pre></td></tr></table></figure>

<h3 id="测试集群负载均衡高可用"><a href="#测试集群负载均衡高可用" class="headerlink" title="测试集群负载均衡高可用"></a>测试集群负载均衡高可用</h3><p>查看master1的vip</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">ip <span class="hljs-selector-tag">a</span><br></code></pre></td></tr></table></figure>

<p><img src="/../img/OpenEuler-K8S%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%EF%BC%88%E5%86%85%E9%83%A8etcd%EF%BC%89/5dcb706337defc19126fb8173eda199a697559838.png" srcset="/img/loading.gif" lazyload alt="image-20231109232708584"></p>
<p>模拟master1的宕机测试，看看vip会不会漂移到master2去</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-string">[master1]</span> poweroff<br></code></pre></td></tr></table></figure>

<p><img src="/../img/OpenEuler-K8S%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%EF%BC%88%E5%86%85%E9%83%A8etcd%EF%BC%89/39e3e1b94663d206a210db27df4eafa9697559838.png" srcset="/img/loading.gif" lazyload alt="image-20231109232803276"></p>
<p>这时候查看master2的ip列表</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-string">[master2]</span> poweroff<br></code></pre></td></tr></table></figure>

<p><img src="/../img/OpenEuler-K8S%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%EF%BC%88%E5%86%85%E9%83%A8etcd%EF%BC%89/8444a87fcda5bc6bb2982645b2bf4bd3697559838.png" srcset="/img/loading.gif" lazyload alt="image-20231109232825999"></p>
<p>结论：这时可以知道，负载均衡集群成功，当master1出现宕机情况，vip会从master1漂移到master2</p>
<h2 id="docker安装"><a href="#docker安装" class="headerlink" title="docker安装"></a>docker安装</h2><h3 id="安装docker"><a href="#安装docker" class="headerlink" title="安装docker"></a>安装docker</h3><p>操作节点[master1，master2，master3,node01]</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs awk">wget https:<span class="hljs-regexp">//</span>download.docker.com<span class="hljs-regexp">/linux/</span>static<span class="hljs-regexp">/stable/</span>x86_64/docker-<span class="hljs-number">26.0</span>.<span class="hljs-number">1</span>.tgz<br>tar xf docker-*.tgz<br>cp docker<span class="hljs-regexp">/* /u</span>sr<span class="hljs-regexp">/bin/</span><br><span class="hljs-comment">#创建containerd的service文件,并且启动</span><br>cat &gt;<span class="hljs-regexp">/etc/</span>systemd<span class="hljs-regexp">/system/</span>containerd.service &lt;&lt;EOF<br>[Unit]<br>Description=containerd container runtime<br>Documentation=https:<span class="hljs-regexp">//</span>containerd.io<br>After=network.target local-fs.target<br>[Service]<br>ExecStartPre=-<span class="hljs-regexp">/sbin/m</span>odprobe overlay<br>ExecStart=<span class="hljs-regexp">/usr/</span>bin/containerd<br>Type=notify<br>Delegate=yes<br>KillMode=process<br>Restart=always<br>RestartSec=<span class="hljs-number">5</span><br>LimitNPROC=infinity<br>LimitCORE=infinity<br>LimitNOFILE=<span class="hljs-number">1048576</span><br>TasksMax=infinity<br>OOMScoreAdjust=-<span class="hljs-number">999</span><br>[Install]<br>WantedBy=multi-user.target<br>EOF<br>systemctl enable --now containerd.service<br><br><span class="hljs-comment">#准备docker的service文件</span><br><br>cat &gt; <span class="hljs-regexp">/etc/</span>systemd<span class="hljs-regexp">/system/</span>docker.service &lt;&lt;EOF<br>[Unit]<br>Description=Docker Application Container Engine<br>Documentation=https:<span class="hljs-regexp">//</span>docs.docker.com<br>After=network-online.target firewalld.service containerd.service<br>Wants=network-online.target<br>Requires=docker.socket containerd.service<br>[Service]<br>Type=notify<br>ExecStart=<span class="hljs-regexp">/usr/</span>bin<span class="hljs-regexp">/dockerd -H fd:/</span><span class="hljs-regexp">/ --containerd=/</span>run<span class="hljs-regexp">/containerd/</span>containerd.sock<br>ExecReload=<span class="hljs-regexp">/bin/</span>kill -s HUP <span class="hljs-variable">$MAINPID</span><br>TimeoutSec=<span class="hljs-number">0</span><br>RestartSec=<span class="hljs-number">2</span><br>Restart=always<br>StartLimitBurst=<span class="hljs-number">3</span><br>StartLimitInterval=<span class="hljs-number">60</span>s<br>LimitNOFILE=infinity<br>LimitNPROC=infinity<br>LimitCORE=infinity<br>TasksMax=infinity<br>Delegate=yes<br>KillMode=process<br>OOMScoreAdjust=-<span class="hljs-number">500</span><br>[Install]<br>WantedBy=multi-user.target<br>EOF<br><br><br><span class="hljs-comment">#准备docker的socket文件</span><br><br>cat &gt; <span class="hljs-regexp">/etc/</span>systemd<span class="hljs-regexp">/system/</span>docker.socket &lt;&lt;EOF<br>[Unit]<br>Description=Docker Socket <span class="hljs-keyword">for</span> the API<br>[Socket]<br>ListenStream=<span class="hljs-regexp">/var/</span>run/docker.sock<br>SocketMode=<span class="hljs-number">0660</span><br>SocketUser=root<br>SocketGroup=docker<br>[Install]<br>WantedBy=sockets.target<br>EOF<br>groupadd docker<br><br>systemctl enable --now docker.socket  &amp;&amp; systemctl enable --now docker.service<br><br><br><span class="hljs-comment">#验证</span><br>mkdir <span class="hljs-regexp">/etc/</span>docker<br>cat &gt;<span class="hljs-regexp">/etc/</span>docker/daemon.json &lt;&lt;EOF<br>&#123;<br>  <span class="hljs-string">&quot;exec-opts&quot;</span>: [<span class="hljs-string">&quot;native.cgroupdriver=systemd&quot;</span>],<br>  <span class="hljs-string">&quot;registry-mirrors&quot;</span>: [<br>    <span class="hljs-string">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span>,<br>    <span class="hljs-string">&quot;http://hub-mirror.c.163.com&quot;</span><br>  ],<br>  <span class="hljs-string">&quot;max-concurrent-downloads&quot;</span>: <span class="hljs-number">10</span>,<br>  <span class="hljs-string">&quot;log-driver&quot;</span>: <span class="hljs-string">&quot;json-file&quot;</span>,<br>  <span class="hljs-string">&quot;log-level&quot;</span>: <span class="hljs-string">&quot;warn&quot;</span>,<br>  <span class="hljs-string">&quot;log-opts&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;max-size&quot;</span>: <span class="hljs-string">&quot;10m&quot;</span>,<br>    <span class="hljs-string">&quot;max-file&quot;</span>: <span class="hljs-string">&quot;3&quot;</span><br>    &#125;,<br>  <span class="hljs-string">&quot;data-root&quot;</span>: <span class="hljs-string">&quot;/var/lib/docker&quot;</span><br>&#125;<br>EOF<br>systemctl restart docker<br></code></pre></td></tr></table></figure>

<h3 id="安装cri-docker"><a href="#安装cri-docker" class="headerlink" title="安装cri-docker"></a>安装cri-docker</h3><p>操作节点[master1，master2，master3,node01]</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs awk">wget https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/Mirantis/</span>cri-dockerd<span class="hljs-regexp">/releases/</span>download<span class="hljs-regexp">/v0.3.12/</span>cri-dockerd-<span class="hljs-number">0.3</span>.<span class="hljs-number">12</span>.amd64.tgz<br><br>tar -zxvf cri-dockerd-<span class="hljs-number">0.3</span>.*.amd64.tgz<br>cp cri-dockerd<span class="hljs-regexp">/cri-dockerd  /u</span>sr<span class="hljs-regexp">/bin/</span><br>chmod +x <span class="hljs-regexp">/usr/</span>bin/cri-dockerd<br><br><br><span class="hljs-comment">#写入启动配置文件</span><br>cat &gt;  <span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/systemd/</span>system/cri-docker.service &lt;&lt;EOF<br>[Unit]<br>Description=CRI Interface <span class="hljs-keyword">for</span> Docker Application Container Engine<br>Documentation=https:<span class="hljs-regexp">//</span>docs.mirantis.com<br>After=network-online.target firewalld.service docker.service<br>Wants=network-online.target<br>Requires=cri-docker.socket<br> <br>[Service]<br>Type=notify<br>ExecStart=<span class="hljs-regexp">/usr/</span>bin<span class="hljs-regexp">/cri-dockerd --network-plugin=cni --pod-infra-container-image=registry.aliyuncs.com/g</span>oogle_containers/pause:<span class="hljs-number">3.9</span><br>ExecReload=<span class="hljs-regexp">/bin/</span>kill -s HUP <span class="hljs-variable">$MAINPID</span><br>TimeoutSec=<span class="hljs-number">0</span><br>RestartSec=<span class="hljs-number">2</span><br>Restart=always<br> <br>StartLimitBurst=<span class="hljs-number">3</span><br> <br>StartLimitInterval=<span class="hljs-number">60</span>s<br> <br>LimitNOFILE=infinity<br>LimitNPROC=infinity<br>LimitCORE=infinity<br> <br>TasksMax=infinity<br>Delegate=yes<br>KillMode=process<br> <br>[Install]<br>WantedBy=multi-user.target<br>EOF<br><br><br><span class="hljs-comment">#写入socket配置文件</span><br>cat &gt; <span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/systemd/</span>system/cri-docker.socket &lt;&lt;EOF<br>[Unit]<br>Description=CRI Docker Socket <span class="hljs-keyword">for</span> the API<br>PartOf=cri-docker.service<br> <br>[Socket]<br>ListenStream=%t/cri-dockerd.sock<br>SocketMode=<span class="hljs-number">0660</span><br>SocketUser=root<br>SocketGroup=docker<br> <br>[Install]<br>WantedBy=sockets.target<br>EOF<br><br>systemctl daemon-reload &amp;&amp; systemctl enable cri-docker --now<br></code></pre></td></tr></table></figure>

<h2 id="K8S集群安装"><a href="#K8S集群安装" class="headerlink" title="K8S集群安装"></a>K8S集群安装</h2><h3 id="安装k8s所需的工具"><a href="#安装k8s所需的工具" class="headerlink" title="安装k8s所需的工具"></a>安装k8s所需的工具</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs routeros">操作节点[master1，master2，master3,node01]<br><br>yum -y install  kubeadm kubelet kubectl<br><br><span class="hljs-comment">#为了实现docker使用的cgroupdriver与kubelet使用的cgroup的一致性，配置如下：</span><br>sed -i <span class="hljs-string">&#x27;s/^KUBELET_EXTRA_ARGS=/KUBELET_EXTRA_ARGS=&quot;--cgroup-driver=systemd&quot;/g&#x27;</span> /etc/sysconfig/kubelet<br><br><span class="hljs-comment">#设置kubelet为开机自启动即可，由于没有生成配置文件，集群初始化后自动启动</span><br>systemctl <span class="hljs-built_in">enable</span> kubelet<br>systemctl <span class="hljs-built_in">enable</span> kubelet.service<br></code></pre></td></tr></table></figure>

<h3 id="集群初始化"><a href="#集群初始化" class="headerlink" title="集群初始化"></a>集群初始化</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">操作节点[master1]</span><br><br><span class="hljs-string">cat</span> <span class="hljs-string">&gt;</span> <span class="hljs-string">kubeadm-config.yaml</span> <span class="hljs-string">&lt;&lt;</span> <span class="hljs-string">EOF</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">kubeadm.k8s.io/v1beta3</span><br><span class="hljs-attr">bootstrapTokens:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">groups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">system:bootstrappers:kubeadm:default-node-token</span><br>  <span class="hljs-attr">token:</span> <span class="hljs-string">abcdef.0123456789abcdef</span><br>  <span class="hljs-attr">ttl:</span> <span class="hljs-string">24h0m0s</span><br>  <span class="hljs-attr">usages:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">signing</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">authentication</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">InitConfiguration</span><br><span class="hljs-attr">localAPIEndpoint:</span><br>  <span class="hljs-attr">advertiseAddress:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.48</span><span class="hljs-number">.101</span><br>  <span class="hljs-attr">bindPort:</span> <span class="hljs-number">6443</span><br><span class="hljs-attr">nodeRegistration:</span><br>  <span class="hljs-attr">criSocket:</span> <span class="hljs-string">unix:///var/run/cri-dockerd.sock</span><br>  <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>  <span class="hljs-attr">taints:</span> <span class="hljs-literal">null</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiServer:</span><br>  <span class="hljs-attr">timeoutForControlPlane:</span> <span class="hljs-string">4m0s</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">kubeadm.k8s.io/v1beta3</span><br><span class="hljs-attr">certificatesDir:</span> <span class="hljs-string">/etc/kubernetes/pki</span><br><span class="hljs-attr">clusterName:</span> <span class="hljs-string">kubernetes</span><br><span class="hljs-attr">controllerManager:</span> &#123;&#125;<br><span class="hljs-attr">dns:</span> &#123;&#125;<br><span class="hljs-attr">etcd:</span><br>  <span class="hljs-attr">local:</span><br>    <span class="hljs-attr">dataDir:</span> <span class="hljs-string">/var/lib/etcd</span><br><span class="hljs-attr">imageRepository:</span> <span class="hljs-string">registry.aliyuncs.com/google_containers</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterConfiguration</span><br><span class="hljs-attr">kubernetesVersion:</span> <span class="hljs-number">1.28</span><span class="hljs-number">.2</span><br><span class="hljs-attr">networking:</span><br>  <span class="hljs-attr">dnsDomain:</span> <span class="hljs-string">cluster.local</span><br>  <span class="hljs-attr">podSubnet:</span> <span class="hljs-number">10.244</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-string">/16</span><br>  <span class="hljs-attr">serviceSubnet:</span> <span class="hljs-number">10.96</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-string">/12</span><br><span class="hljs-attr">scheduler:</span> &#123;&#125;<br><span class="hljs-attr">controlPlaneEndpoint:</span> <span class="hljs-string">&quot;192.168.48.200:16443&quot;</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">kubeproxy.config.k8s.io/v1alpha1</span><br><span class="hljs-attr">bindAddress:</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><br><span class="hljs-attr">bindAddressHardFail:</span> <span class="hljs-literal">false</span><br><span class="hljs-attr">clientConnection:</span><br>  <span class="hljs-attr">acceptContentTypes:</span> <span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-attr">burst:</span> <span class="hljs-number">0</span><br>  <span class="hljs-attr">contentType:</span> <span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-attr">kubeconfig:</span> <span class="hljs-string">/var/lib/kube-proxy/kubeconfig.conf</span><br>  <span class="hljs-attr">qps:</span> <span class="hljs-number">0</span><br><span class="hljs-attr">clusterCIDR:</span> <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-attr">configSyncPeriod:</span> <span class="hljs-string">0s</span><br><span class="hljs-attr">conntrack:</span><br>  <span class="hljs-attr">maxPerCore:</span> <span class="hljs-literal">null</span><br>  <span class="hljs-attr">min:</span> <span class="hljs-literal">null</span><br>  <span class="hljs-attr">tcpCloseWaitTimeout:</span> <span class="hljs-literal">null</span><br>  <span class="hljs-attr">tcpEstablishedTimeout:</span> <span class="hljs-literal">null</span><br><span class="hljs-attr">detectLocal:</span><br>  <span class="hljs-attr">bridgeInterface:</span> <span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-attr">interfaceNamePrefix:</span> <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-attr">detectLocalMode:</span> <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-attr">enableProfiling:</span> <span class="hljs-literal">false</span><br><span class="hljs-attr">healthzBindAddress:</span> <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-attr">hostnameOverride:</span> <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-attr">iptables:</span><br>  <span class="hljs-attr">localhostNodePorts:</span> <span class="hljs-literal">null</span><br>  <span class="hljs-attr">masqueradeAll:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">masqueradeBit:</span> <span class="hljs-literal">null</span><br>  <span class="hljs-attr">minSyncPeriod:</span> <span class="hljs-string">0s</span><br>  <span class="hljs-attr">syncPeriod:</span> <span class="hljs-string">0s</span><br><span class="hljs-attr">ipvs:</span><br>  <span class="hljs-attr">excludeCIDRs:</span> <span class="hljs-literal">null</span><br>  <span class="hljs-attr">minSyncPeriod:</span> <span class="hljs-string">0s</span><br>  <span class="hljs-attr">scheduler:</span> <span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-attr">strictARP:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">syncPeriod:</span> <span class="hljs-string">0s</span><br>  <span class="hljs-attr">tcpFinTimeout:</span> <span class="hljs-string">0s</span><br>  <span class="hljs-attr">tcpTimeout:</span> <span class="hljs-string">0s</span><br>  <span class="hljs-attr">udpTimeout:</span> <span class="hljs-string">0s</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">KubeProxyConfiguration</span><br><span class="hljs-attr">logging:</span><br>  <span class="hljs-attr">flushFrequency:</span> <span class="hljs-number">0</span><br>  <span class="hljs-attr">options:</span><br>    <span class="hljs-attr">json:</span><br>      <span class="hljs-attr">infoBufferSize:</span> <span class="hljs-string">&quot;0&quot;</span><br>  <span class="hljs-attr">verbosity:</span> <span class="hljs-number">0</span><br><span class="hljs-attr">metricsBindAddress:</span> <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-attr">mode:</span> <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-attr">nodePortAddresses:</span> <span class="hljs-literal">null</span><br><span class="hljs-attr">oomScoreAdj:</span> <span class="hljs-literal">null</span><br><span class="hljs-attr">portRange:</span> <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-attr">showHiddenMetricsForVersion:</span> <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-attr">winkernel:</span><br>  <span class="hljs-attr">enableDSR:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">forwardHealthCheckVip:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">networkName:</span> <span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-attr">rootHnsEndpointName:</span> <span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-attr">sourceVip:</span> <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">kubelet.config.k8s.io/v1beta1</span><br><span class="hljs-attr">authentication:</span><br>  <span class="hljs-attr">anonymous:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">webhook:</span><br>    <span class="hljs-attr">cacheTTL:</span> <span class="hljs-string">0s</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">x509:</span><br>    <span class="hljs-attr">clientCAFile:</span> <span class="hljs-string">/etc/kubernetes/pki/ca.crt</span><br><span class="hljs-attr">authorization:</span><br>  <span class="hljs-attr">mode:</span> <span class="hljs-string">Webhook</span><br>  <span class="hljs-attr">webhook:</span><br>    <span class="hljs-attr">cacheAuthorizedTTL:</span> <span class="hljs-string">0s</span><br>    <span class="hljs-attr">cacheUnauthorizedTTL:</span> <span class="hljs-string">0s</span><br><span class="hljs-attr">cgroupDriver:</span> <span class="hljs-string">systemd</span><br><span class="hljs-attr">clusterDNS:</span><br><span class="hljs-bullet">-</span> <span class="hljs-number">10.96</span><span class="hljs-number">.0</span><span class="hljs-number">.10</span><br><span class="hljs-attr">clusterDomain:</span> <span class="hljs-string">cluster.local</span><br><span class="hljs-attr">containerRuntimeEndpoint:</span> <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-attr">cpuManagerReconcilePeriod:</span> <span class="hljs-string">0s</span><br><span class="hljs-attr">evictionPressureTransitionPeriod:</span> <span class="hljs-string">0s</span><br><span class="hljs-attr">fileCheckFrequency:</span> <span class="hljs-string">0s</span><br><span class="hljs-attr">healthzBindAddress:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><br><span class="hljs-attr">healthzPort:</span> <span class="hljs-number">10248</span><br><span class="hljs-attr">httpCheckFrequency:</span> <span class="hljs-string">0s</span><br><span class="hljs-attr">imageMinimumGCAge:</span> <span class="hljs-string">0s</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">KubeletConfiguration</span><br><span class="hljs-attr">logging:</span><br>  <span class="hljs-attr">flushFrequency:</span> <span class="hljs-number">0</span><br>  <span class="hljs-attr">options:</span><br>    <span class="hljs-attr">json:</span><br>      <span class="hljs-attr">infoBufferSize:</span> <span class="hljs-string">&quot;0&quot;</span><br>  <span class="hljs-attr">verbosity:</span> <span class="hljs-number">0</span><br><span class="hljs-attr">memorySwap:</span> &#123;&#125;<br><span class="hljs-attr">nodeStatusReportFrequency:</span> <span class="hljs-string">0s</span><br><span class="hljs-attr">nodeStatusUpdateFrequency:</span> <span class="hljs-string">0s</span><br><span class="hljs-attr">rotateCertificates:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">runtimeRequestTimeout:</span> <span class="hljs-string">0s</span><br><span class="hljs-attr">shutdownGracePeriod:</span> <span class="hljs-string">0s</span><br><span class="hljs-attr">shutdownGracePeriodCriticalPods:</span> <span class="hljs-string">0s</span><br><span class="hljs-attr">staticPodPath:</span> <span class="hljs-string">/etc/kubernetes/manifests</span><br><span class="hljs-attr">streamingConnectionIdleTimeout:</span> <span class="hljs-string">0s</span><br><span class="hljs-attr">syncFrequency:</span> <span class="hljs-string">0s</span><br><span class="hljs-attr">volumeStatsAggPeriod:</span> <span class="hljs-string">0s</span><br><br><span class="hljs-string">EOF</span><br><br><span class="hljs-string">kubeadm</span> <span class="hljs-string">config</span> <span class="hljs-string">migrate</span> <span class="hljs-string">--old-config</span> <span class="hljs-string">kubeadm-config.yaml</span> <span class="hljs-string">--new-config</span> <span class="hljs-string">new.yaml</span><br><br></code></pre></td></tr></table></figure>

<h3 id="准备k8s所需的镜像"><a href="#准备k8s所需的镜像" class="headerlink" title="准备k8s所需的镜像"></a>准备k8s所需的镜像</h3><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs arduino">操作节点[master1,master2,master3]<br><br>kubeadm config images pull --config /root/<span class="hljs-keyword">new</span>.yaml <br></code></pre></td></tr></table></figure>

<p><img src="/../img/OpenEuler-K8S%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%EF%BC%88%E5%86%85%E9%83%A8etcd%EF%BC%89/5e169c5a5163841439604a8215344f96697559838.png" srcset="/img/loading.gif" lazyload alt="image-20231110100341121"></p>
<h3 id="master1节点初始化"><a href="#master1节点初始化" class="headerlink" title="master1节点初始化"></a>master1节点初始化</h3><p>操作节点[master1]</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">kubeadm init --config <span class="hljs-regexp">/root/</span><span class="hljs-keyword">new</span>.yaml  --upload-certs<br></code></pre></td></tr></table></figure>

<p>会生成信息</p>
<p><img src="/../img/OpenEuler-K8S%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%EF%BC%88%E5%86%85%E9%83%A8etcd%EF%BC%89/2ca4c00f1f496c118274f321bdc16f62697559838.png" srcset="/img/loading.gif" lazyload alt="image-20231110175843902"></p>
<p>记录信息后面会用到</p>
<p>初始化成功以后，会产生Token值，用于其他节点加入时使用，因此要记录下初始化成功生成的token值（令牌值），<strong>有效期24小时，后续需要操作可以重新生成Token</strong></p>
<p>操作节点[master1]</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs llvm">kubeadm join <span class="hljs-number">192.168</span>.<span class="hljs-number">48.200</span>:<span class="hljs-number">16443</span> --token abcdef.<span class="hljs-number">0123456789</span>abcdef \<br>        --discovery-token-ca-cert-hash sha<span class="hljs-number">256</span>:<span class="hljs-keyword">cc</span><span class="hljs-number">5427e0</span>e<span class="hljs-number">133</span>d<span class="hljs-number">95250</span>ab<span class="hljs-number">0</span>aa<span class="hljs-number">90976</span>fea<span class="hljs-number">2</span><span class="hljs-keyword">c</span><span class="hljs-number">383278</span>b<span class="hljs-number">6345</span>fd<span class="hljs-number">7e8</span><span class="hljs-keyword">c</span><span class="hljs-number">28702</span>ac<span class="hljs-number">8</span>dfc<span class="hljs-number">61</span>f \<br>        --control-plane --certificate-key <span class="hljs-number">45</span>eeadfc<span class="hljs-number">9135</span>a<span class="hljs-number">368</span>d<span class="hljs-number">08582</span>a<span class="hljs-number">90</span><span class="hljs-keyword">c</span><span class="hljs-number">779</span><span class="hljs-keyword">c</span><span class="hljs-number">0934</span>d<span class="hljs-number">24</span><span class="hljs-keyword">c</span><span class="hljs-number">54</span>f<span class="hljs-number">56134</span><span class="hljs-keyword">c</span><span class="hljs-number">65</span>d<span class="hljs-number">67516</span>f<span class="hljs-number">5e6</span>f<span class="hljs-number">981</span>d<br><br><br>kubeadm join <span class="hljs-number">192.168</span>.<span class="hljs-number">48.200</span>:<span class="hljs-number">16443</span> --token abcdef.<span class="hljs-number">0123456789</span>abcdef \<br>        --discovery-token-ca-cert-hash sha<span class="hljs-number">256</span>:<span class="hljs-keyword">cc</span><span class="hljs-number">5427e0</span>e<span class="hljs-number">133</span>d<span class="hljs-number">95250</span>ab<span class="hljs-number">0</span>aa<span class="hljs-number">90976</span>fea<span class="hljs-number">2</span><span class="hljs-keyword">c</span><span class="hljs-number">383278</span>b<span class="hljs-number">6345</span>fd<span class="hljs-number">7e8</span><span class="hljs-keyword">c</span><span class="hljs-number">28702</span>ac<span class="hljs-number">8</span>dfc<span class="hljs-number">61</span>f<br><br></code></pre></td></tr></table></figure>

<p><code>操作kubect报错：</code></p>
<p><img src="/../img/OpenEuler-K8S%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%EF%BC%88%E5%86%85%E9%83%A8etcd%EF%BC%89/83ea46816d5cf9479606844f0b982812697559838.png" srcset="/img/loading.gif" lazyload alt="image-20231110180035297"></p>
<p>此时通过kubectl操作，会出现失败，因为还没有将集群的”钥匙”交给root用户。<code>/etc/kubernetes/admin.conf</code> 文件是 Kubernetes（K8s）集群中的管理员配置文件，它包含了用于管理集群的身份验证和访问信息。所以下面进行配置环境变量，用于访问Kubernetes集群：</p>
<p><code>添加环境变量</code></p>
<p>操作节点[master1]</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$HOME</span>/.kube<br>sudo <span class="hljs-built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="hljs-variable">$HOME</span>/.kube/config<br>sudo <span class="hljs-built_in">chown</span> $(<span class="hljs-built_in">id</span> -u):$(<span class="hljs-built_in">id</span> -g) <span class="hljs-variable">$HOME</span>/.kube/config<br></code></pre></td></tr></table></figure>

<h3 id="添加其他master节点至集群中"><a href="#添加其他master节点至集群中" class="headerlink" title="添加其他master节点至集群中"></a>添加其他master节点至集群中</h3><p>操作节点[master2,master3]</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs llvm">操作节点[master<span class="hljs-number">2</span><span class="hljs-punctuation">,</span>master<span class="hljs-number">3</span>]<br>kubeadm join <span class="hljs-number">192.168</span>.<span class="hljs-number">48.200</span>:<span class="hljs-number">16443</span> --token abcdef.<span class="hljs-number">0123456789</span>abcdef \<br>        --discovery-token-ca-cert-hash sha<span class="hljs-number">256</span>:<span class="hljs-keyword">cc</span><span class="hljs-number">5427e0</span>e<span class="hljs-number">133</span>d<span class="hljs-number">95250</span>ab<span class="hljs-number">0</span>aa<span class="hljs-number">90976</span>fea<span class="hljs-number">2</span><span class="hljs-keyword">c</span><span class="hljs-number">383278</span>b<span class="hljs-number">6345</span>fd<span class="hljs-number">7e8</span><span class="hljs-keyword">c</span><span class="hljs-number">28702</span>ac<span class="hljs-number">8</span>dfc<span class="hljs-number">61</span>f \<br>        --control-plane --certificate-key <span class="hljs-number">45</span>eeadfc<span class="hljs-number">9135</span>a<span class="hljs-number">368</span>d<span class="hljs-number">08582</span>a<span class="hljs-number">90</span><span class="hljs-keyword">c</span><span class="hljs-number">779</span><span class="hljs-keyword">c</span><span class="hljs-number">0934</span>d<span class="hljs-number">24</span><span class="hljs-keyword">c</span><span class="hljs-number">54</span>f<span class="hljs-number">56134</span><span class="hljs-keyword">c</span><span class="hljs-number">65</span>d<span class="hljs-number">67516</span>f<span class="hljs-number">5e6</span>f<span class="hljs-number">981</span>d \<br>        --cri-socket unix:///var/run/cri-dockerd.sock <br></code></pre></td></tr></table></figure>

<p>注意：这里末尾添加了<code>--cri-socket unix:///var/run/cri-dockerd.sock </code></p>
<p>接着给<code>master2</code>添加环境变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">操作节点[master2,master3]<br><span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$HOME</span>/.kube<br>sudo <span class="hljs-built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="hljs-variable">$HOME</span>/.kube/config<br>sudo <span class="hljs-built_in">chown</span> $(<span class="hljs-built_in">id</span> -u):$(<span class="hljs-built_in">id</span> -g) <span class="hljs-variable">$HOME</span>/.kube/config<br></code></pre></td></tr></table></figure>

<p><img src="/../img/OpenEuler-K8S%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%EF%BC%88%E5%86%85%E9%83%A8etcd%EF%BC%89/01572acbf560d308e3d4bb373eca56fd697559838.png" srcset="/img/loading.gif" lazyload alt="image-20231110180919008"></p>
<p>这里没有展示master3的图片，但是步骤一样的</p>
<h3 id="模拟Token过期重新生成并加入Node节点"><a href="#模拟Token过期重新生成并加入Node节点" class="headerlink" title="模拟Token过期重新生成并加入Node节点"></a>模拟Token过期重新生成并加入Node节点</h3><p>假设加入集群的token过期了。node01无法加入了，这里就模拟一下这种情况</p>
<ol>
<li>Token过期后生成新的token：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubeadm token create --print-join-command<br></code></pre></td></tr></table></figure>

<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs vim">[root@master1 ~]# kubeadm token create --<span class="hljs-keyword">print</span>-<span class="hljs-keyword">join</span>-<span class="hljs-keyword">command</span><br>kubeadm <span class="hljs-keyword">join</span> <span class="hljs-number">192.168</span>.<span class="hljs-number">48.200</span>:<span class="hljs-number">16443</span> --token tn5q1b.<span class="hljs-number">7</span>w1jj77ewup7k2in --discovery-token-<span class="hljs-keyword">ca</span>-cert-hash <span class="hljs-built_in">sha256</span>:cc5427e0e133d95250ab0aa90976fea2c383278b6345fd7e8c28702ac8dfc61f<br><br></code></pre></td></tr></table></figure>

<p>其中，<code>192.168.48.200:16443</code> 是你的 Kubernetes API 服务器的地址和端口，<code>tn5q1b.7w1jj77ewup7k2in</code> 是新的令牌，<code>sha256:cc5427e0e133d95250ab0aa90976fea2c383278b6345fd7e8c28702ac8dfc61f</code> 是令牌的 CA 证书哈希值。</p>
<ol start="2">
<li>Master需要生成–certificate-key：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubeadm init phase upload-certs --upload-certs<br></code></pre></td></tr></table></figure>

<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs applescript">[root@master1 ~]<span class="hljs-comment"># kubeadm init phase upload-certs --upload-certs</span><br>W1110 <span class="hljs-number">18</span>:<span class="hljs-number">12</span>:<span class="hljs-number">03.426245</span>   <span class="hljs-number">10185</span> <span class="hljs-built_in">version</span>.go:<span class="hljs-number">104</span>] could <span class="hljs-keyword">not</span> fetch a Kubernetes <span class="hljs-built_in">version</span> <span class="hljs-keyword">from</span> <span class="hljs-keyword">the</span> internet: unable <span class="hljs-keyword">to</span> <span class="hljs-keyword">get</span> URL <span class="hljs-string">&quot;https://dl.k8s.io/release/stable-1.txt&quot;</span>: Get <span class="hljs-string">&quot;https://dl.k8s.io/release/stable-1.txt&quot;</span>: context deadline exceeded (Client.Timeout exceeded <span class="hljs-keyword">while</span> awaiting headers)<br>W1110 <span class="hljs-number">18</span>:<span class="hljs-number">12</span>:<span class="hljs-number">03.426320</span>   <span class="hljs-number">10185</span> <span class="hljs-built_in">version</span>.go:<span class="hljs-number">105</span>] falling <span class="hljs-keyword">back</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">the</span> <span class="hljs-keyword">local</span> client <span class="hljs-built_in">version</span>: v1<span class="hljs-number">.28</span><span class="hljs-number">.2</span><br>[upload-certs] Storing <span class="hljs-keyword">the</span> certificates <span class="hljs-keyword">in</span> Secret <span class="hljs-string">&quot;kubeadm-certs&quot;</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">the</span> <span class="hljs-string">&quot;kube-system&quot;</span> Namespace<br>[upload-certs] Using certificate key:<br><span class="hljs-number">5</span>d3706028d5e569324a4c456c81ae0f5551ece88b3132f03917668c6b0605128<br></code></pre></td></tr></table></figure>

<p>其中，<code>5d3706028d5e569324a4c456c81ae0f5551ece88b3132f03917668c6b0605128</code> 是证书密钥。</p>
<ol start="3">
<li>生成新的Token用于集群添加新Node节点</li>
</ol>
<p>操作节点[node01]</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">kubeadm join 192.168.48.200<span class="hljs-function">:16443</span> <span class="hljs-params">--token</span> tn5q1b.7w1jj77ewup7k2in <span class="hljs-params">--discovery-token-ca-cert-hash</span> sha256<span class="hljs-function">:cc5427e0e133d95250ab0aa90976fea2c383278b6345fd7e8c28702ac8dfc61f</span>  \<br>        <span class="hljs-params">--cri-socket</span> unix:<span class="hljs-string">///var/run/cri-dockerd.sock</span> <br></code></pre></td></tr></table></figure>

<p>注意：这里末尾添加了<code>--cri-socket unix:///var/run/cri-dockerd.sock </code></p>
<p><img src="/../img/OpenEuler-K8S%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%EF%BC%88%E5%86%85%E9%83%A8etcd%EF%BC%89/dc4291fbc79803803163159cd9c7c3ce697559838.png" srcset="/img/loading.gif" lazyload alt="image-20231110181623386"></p>
<p>这时在master查看node状态（显示为notready不影响）</p>
<p><img src="/../img/OpenEuler-K8S%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%EF%BC%88%E5%86%85%E9%83%A8etcd%EF%BC%89/cebcb438c3ccb05dbba530f5d28085e7697559838.png" srcset="/img/loading.gif" lazyload alt="image-20231111145807000"></p>
<h3 id="模拟新加master节点的加入K8S集群中"><a href="#模拟新加master节点的加入K8S集群中" class="headerlink" title="模拟新加master节点的加入K8S集群中"></a>模拟新加master节点的加入K8S集群中</h3><p>假设我们新加master节点的话，就拼接token，<code>从刚刚生成的token拼接</code></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs vim">[root@master1 ~]# kubeadm token create --<span class="hljs-keyword">print</span>-<span class="hljs-keyword">join</span>-<span class="hljs-keyword">command</span><br>kubeadm <span class="hljs-keyword">join</span> <span class="hljs-number">192.168</span>.<span class="hljs-number">48.200</span>:<span class="hljs-number">16443</span> --token tn5q1b.<span class="hljs-number">7</span>w1jj77ewup7k2in --discovery-token-<span class="hljs-keyword">ca</span>-cert-hash <span class="hljs-built_in">sha256</span>:cc5427e0e133d95250ab0aa90976fea2c383278b6345fd7e8c28702ac8dfc61f<br></code></pre></td></tr></table></figure>

<p>这里提取信息1</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">kubeadm join <span class="hljs-number">192.168</span>.<span class="hljs-number">48.200</span>:<span class="hljs-number">16443</span> --token tn<span class="hljs-number">5</span>q<span class="hljs-number">1</span>b.<span class="hljs-number">7</span>w<span class="hljs-number">1</span>jj<span class="hljs-number">77</span>ewup<span class="hljs-number">7</span>k<span class="hljs-number">2</span>in --discovery-token-ca-cert-hash sha<span class="hljs-number">256</span>:<span class="hljs-keyword">cc</span><span class="hljs-number">5427e0</span>e<span class="hljs-number">133</span>d<span class="hljs-number">95250</span>ab<span class="hljs-number">0</span>aa<span class="hljs-number">90976</span>fea<span class="hljs-number">2</span><span class="hljs-keyword">c</span><span class="hljs-number">383278</span>b<span class="hljs-number">6345</span>fd<span class="hljs-number">7e8</span><span class="hljs-keyword">c</span><span class="hljs-number">28702</span>ac<span class="hljs-number">8</span>dfc<span class="hljs-number">61</span>f<br></code></pre></td></tr></table></figure>

<p>接着</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs applescript">[root@master1 ~]<span class="hljs-comment"># kubeadm init phase upload-certs --upload-certs</span><br>W1110 <span class="hljs-number">18</span>:<span class="hljs-number">12</span>:<span class="hljs-number">03.426245</span>   <span class="hljs-number">10185</span> <span class="hljs-built_in">version</span>.go:<span class="hljs-number">104</span>] could <span class="hljs-keyword">not</span> fetch a Kubernetes <span class="hljs-built_in">version</span> <span class="hljs-keyword">from</span> <span class="hljs-keyword">the</span> internet: unable <span class="hljs-keyword">to</span> <span class="hljs-keyword">get</span> URL <span class="hljs-string">&quot;https://dl.k8s.io/release/stable-1.txt&quot;</span>: Get <span class="hljs-string">&quot;https://dl.k8s.io/release/stable-1.txt&quot;</span>: context deadline exceeded (Client.Timeout exceeded <span class="hljs-keyword">while</span> awaiting headers)<br>W1110 <span class="hljs-number">18</span>:<span class="hljs-number">12</span>:<span class="hljs-number">03.426320</span>   <span class="hljs-number">10185</span> <span class="hljs-built_in">version</span>.go:<span class="hljs-number">105</span>] falling <span class="hljs-keyword">back</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">the</span> <span class="hljs-keyword">local</span> client <span class="hljs-built_in">version</span>: v1<span class="hljs-number">.28</span><span class="hljs-number">.2</span><br>[upload-certs] Storing <span class="hljs-keyword">the</span> certificates <span class="hljs-keyword">in</span> Secret <span class="hljs-string">&quot;kubeadm-certs&quot;</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">the</span> <span class="hljs-string">&quot;kube-system&quot;</span> Namespace<br>[upload-certs] Using certificate key:<br><span class="hljs-number">5</span>d3706028d5e569324a4c456c81ae0f5551ece88b3132f03917668c6b0605128<br></code></pre></td></tr></table></figure>

<p>这里提取信息2：这里前面要加上<code>--control-plane --certificate-key</code></p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">--control-plane --certificate-key <span class="hljs-number">5</span>d<span class="hljs-number">3706028</span>d<span class="hljs-number">5e569324</span>a<span class="hljs-number">4</span><span class="hljs-keyword">c</span><span class="hljs-number">456</span><span class="hljs-keyword">c</span><span class="hljs-number">81</span>ae<span class="hljs-number">0</span>f<span class="hljs-number">5551</span>ece<span class="hljs-number">88</span>b<span class="hljs-number">3132</span>f<span class="hljs-number">03917668</span><span class="hljs-keyword">c</span><span class="hljs-number">6</span>b<span class="hljs-number">0605128</span><br></code></pre></td></tr></table></figure>

<p>合成</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs stylus">kubeadm join <span class="hljs-number">192.168</span>.<span class="hljs-number">48.200</span>:<span class="hljs-number">16443</span> <span class="hljs-attr">--token</span> tn5q1b.<span class="hljs-number">7</span>w1jj77ewup7k2in \<br>        <span class="hljs-attr">--discovery-token-ca-cert-hash</span> sha256:cc5427e0e133d95250ab0aa90976fea2c383278b6345fd7e8c28702ac8dfc61f  \<br>        <span class="hljs-attr">--control-plane</span> <span class="hljs-attr">--certificate-key</span> <span class="hljs-number">5</span>d3706028d5e569324a4c456c81ae0f5551ece88b3132f03917668c6b0605128 \<br>        <span class="hljs-attr">--cri-socket</span> unix:<span class="hljs-comment">///var/run/cri-dockerd.sock</span><br>        <br>        <br>kubeadm join <span class="hljs-number">192.168</span>.<span class="hljs-number">48.200</span>:<span class="hljs-number">16443</span> <span class="hljs-attr">--token</span> lnkno8<span class="hljs-selector-class">.u4v1l8n9pahzf0kj</span> \<br>        <span class="hljs-attr">--discovery-token-ca-cert-hash</span> sha256:cc5427e0e133d95250ab0aa90976fea2c383278b6345fd7e8c28702ac8dfc61f \<br>        <span class="hljs-attr">--control-plane</span> <span class="hljs-attr">--certificate-key</span> <span class="hljs-number">41</span>e441fe56cb4bdfcc2fc0291958e6b1da54d01f4649b6651471c07583f85cdf \<br>        <span class="hljs-attr">--cri-socket</span> unix:<span class="hljs-comment">///var/run/cri-dockerd.sock</span><br><br><br></code></pre></td></tr></table></figure>

<p>注意：这里末尾添加了<code>--cri-socket unix:///var/run/cri-dockerd.sock </code></p>
<p>图示</p>
<p><img src="/../img/OpenEuler-K8S%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%EF%BC%88%E5%86%85%E9%83%A8etcd%EF%BC%89/9372c65d497c2e2faa4181488a5915bf697559838.png" srcset="/img/loading.gif" lazyload alt="image-20231110182741430"></p>
<h2 id="安装calico网络插件"><a href="#安装calico网络插件" class="headerlink" title="安装calico网络插件"></a>安装calico网络插件</h2><p>操作节点[master1]</p>
<p>添加解析记录，否则无法访问</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">echo <span class="hljs-string">&#x27;185.199.108.133 raw.githubusercontent.com&#x27;</span> &gt;&gt; <span class="hljs-regexp">/etc/</span>hosts<br></code></pre></td></tr></table></figure>

<h3 id="应用operator资源清单文件"><a href="#应用operator资源清单文件" class="headerlink" title="应用operator资源清单文件"></a>应用operator资源清单文件</h3><p>网络组件有很多种，只需要部署其中一个即可，推荐Calico。<br>Calico是一个纯三层的数据中心网络方案，Calico支持广泛的平台，包括Kubernetes、OpenStack等。<br>Calico 在每一个计算节点利用 Linux Kernel 实现了一个高效的虚拟路由器（ vRouter） 来负责数据转发，而每个 vRouter 通过 BGP 协议负责把自己上运行的 workload 的路由信息向整个 Calico 网络内传播。<br>此外，Calico 项目还实现了 Kubernetes 网络策略，提供ACL功能。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">curl https:<span class="hljs-regexp">//</span>raw.githubusercontent.com<span class="hljs-regexp">/projectcalico/</span>calico<span class="hljs-regexp">/v3.25.1/m</span>anifests/calico.yaml -O<br></code></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@master1</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># vim calico.yaml</span><br><span class="hljs-comment">#参考信息</span><br> <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">WAIT_FOR_DATASTORE</span><br>  <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;true&quot;</span><br><span class="hljs-comment">#添加以下两行</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">IP_AUTODETECTION_METHOD</span><br>  <span class="hljs-attr">value:</span> <span class="hljs-string">interface=ens160</span><br><br><span class="hljs-comment">#ens160是你的网卡</span><br></code></pre></td></tr></table></figure>

<p><img src="/../img/OpenEuler-K8S%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%EF%BC%88%E5%86%85%E9%83%A8etcd%EF%BC%89/7d7c1643bf80887d014b17bed1fa7e58697559838.png" srcset="/img/loading.gif" lazyload alt="image-20231110183944854"></p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs coq">sed -i &#x27;s| <span class="hljs-type">docker</span>.io/calico/| <span class="hljs-type">registry</span>.cn-hangzhou.aliyuncs.com/qianyios/|<span class="hljs-type">&#x27; calico</span>.yaml<br>kubectl <span class="hljs-built_in">apply</span> -f calico.yaml<br></code></pre></td></tr></table></figure>

<p><img src="/../img/OpenEuler-K8S%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%EF%BC%88%E5%86%85%E9%83%A8etcd%EF%BC%89/d69a0c211b8d16444f5e6a1c16b8d30c697559838.png" srcset="/img/loading.gif" lazyload alt="image-20231110184031455"></p>
<h3 id="监视kube-system命名空间中pod运行情况"><a href="#监视kube-system命名空间中pod运行情况" class="headerlink" title="监视kube-system命名空间中pod运行情况"></a>监视kube-system命名空间中pod运行情况</h3><p>等待估计20分钟左右吧(确保全部running)</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">kubectl <span class="hljs-built_in">get</span> pods -n kube-<span class="hljs-keyword">system</span><br></code></pre></td></tr></table></figure>

<p><img src="/../img/OpenEuler-K8S%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%EF%BC%88%E5%86%85%E9%83%A8etcd%EF%BC%89/112b7b188c55e689e65508126d225017697559838.png" srcset="/img/loading.gif" lazyload alt="image-20231110193921266"></p>
<h3 id="拿掉master节点的污点"><a href="#拿掉master节点的污点" class="headerlink" title="拿掉master节点的污点"></a>拿掉master节点的污点</h3><p>节点 master1 和 master2 都有一个名为 <code>node-role.kubernetes.io/control-plane:NoSchedule</code> 的污点。这个污点的作用是阻止普通的 Pod 被调度到这些节点上，只允许特定的控制平面组件（如 kube-apiserver、kube-controller-manager 和 kube-scheduler）在这些节点上运行。</p>
<p>这种设置有助于确保控制平面节点专门用于运行 Kubernetes 的核心组件，而不会被普通的工作负载占用。通过将污点添加到节点上，可以确保只有被授权的控制平面组件才能在这些节点上运行。</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">kubectl describe <span class="hljs-keyword">node</span> <span class="hljs-title">master1</span> | grep -i taint<br>kubectl describe <span class="hljs-keyword">node</span> <span class="hljs-title">master2</span> | grep -i taint<br>kubectl describe <span class="hljs-keyword">node</span> <span class="hljs-title">master3</span> | grep -i taint<br></code></pre></td></tr></table></figure>

<p><img src="/../img/OpenEuler-K8S%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%EF%BC%88%E5%86%85%E9%83%A8etcd%EF%BC%89/95f81cefdf6f8ed0fc5b64f9d95b36cc697559838.png" srcset="/img/loading.gif" lazyload alt="image-20231111152324023"></p>
<p>去除污点</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">kubectl taint <span class="hljs-keyword">node</span> <span class="hljs-title">master1</span> <span class="hljs-keyword">node</span><span class="hljs-title">-role</span>.kubernetes.io/control-plane:NoSchedule-<br>kubectl taint <span class="hljs-keyword">node</span> <span class="hljs-title">master2</span> <span class="hljs-keyword">node</span><span class="hljs-title">-role</span>.kubernetes.io/control-plane:NoSchedule-<br>kubectl taint <span class="hljs-keyword">node</span> <span class="hljs-title">master3</span> <span class="hljs-keyword">node</span><span class="hljs-title">-role</span>.kubernetes.io/control-plane:NoSchedule-<br></code></pre></td></tr></table></figure>

<p><img src="/../img/OpenEuler-K8S%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%EF%BC%88%E5%86%85%E9%83%A8etcd%EF%BC%89/19cc087518c84cefc7c622f07f3caf9b697559838.png" srcset="/img/loading.gif" lazyload alt="image-20231111152342956"></p>
<h2 id="安装dashboard"><a href="#安装dashboard" class="headerlink" title="安装dashboard"></a>安装dashboard</h2><p>操作节点[master1]</p>
<p>下载文件</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/dashboard/releases/tag/v2.7.0">https://github.com/kubernetes/dashboard/releases/tag/v2.7.0</a></p>
<p>目前最新版本v2.7.0 </p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">wget https:<span class="hljs-regexp">//</span>raw.githubusercontent.com<span class="hljs-regexp">/kubernetes/</span>dashboard<span class="hljs-regexp">/v2.7.0/</span>aio<span class="hljs-regexp">/deploy/</span>recommended.yaml<br><br></code></pre></td></tr></table></figure>

<p><img src="/../img/OpenEuler-K8S%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%EF%BC%88%E5%86%85%E9%83%A8etcd%EF%BC%89/c7b8683c138dda272c8f013f6ba371d9697559838.png" srcset="/img/loading.gif" lazyload alt="image-20231014174400992"></p>
<p>修改配置文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">vim</span> <span class="hljs-string">recommended.yaml</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">kubernetes-dashboard</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kubernetes-dashboard</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kubernetes-dashboard</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">443</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8443</span><br>      <span class="hljs-attr">nodePort:</span> <span class="hljs-number">30001</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">NodePort</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">kubernetes-dashboard</span><br><br><span class="hljs-meta">---</span><br></code></pre></td></tr></table></figure>

<p><img src="/../img/OpenEuler-K8S%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%EF%BC%88%E5%86%85%E9%83%A8etcd%EF%BC%89/97e182d2ac793b467a67e6fdbb93df67697559838.png" srcset="/img/loading.gif" lazyload alt="image-20231014174511047"></p>
<p>运行dashboard</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq">kubectl <span class="hljs-built_in">apply</span> -f recommended.yaml<br></code></pre></td></tr></table></figure>

<p><img src="/../img/OpenEuler-K8S%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%EF%BC%88%E5%86%85%E9%83%A8etcd%EF%BC%89/805938ac566b9e18bae9f34ca7648907697559838.png" srcset="/img/loading.gif" lazyload alt="image-20231014174622344"></p>
<p>检查运行状态</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">kubectl <span class="hljs-built_in">get</span> pods -n kubernetes-dashboard<br>kubectl <span class="hljs-built_in">get</span> pod,svc -o wide -n kubernetes-dashboard<br></code></pre></td></tr></table></figure>

<p><img src="/../img/OpenEuler-K8S%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%EF%BC%88%E5%86%85%E9%83%A8etcd%EF%BC%89/26685be2850d5a9efeb97d3a89d7dfde697559838.png" srcset="/img/loading.gif" lazyload alt="image-20231111025752605"></p>
<h3 id="创建cluster-admin用户"><a href="#创建cluster-admin用户" class="headerlink" title="创建cluster-admin用户"></a>创建cluster-admin用户</h3><figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs nsis">创建service account并绑定默认cluster-<span class="hljs-literal">admin</span>管理员群角色<br><span class="hljs-comment">#创建用户</span><br>kubectl create serviceaccount dashboard-<span class="hljs-literal">admin</span> -n kubernetes-dashboard<br><span class="hljs-comment">#用户授权</span><br>kubectl create clusterrolebinding dashboard-<span class="hljs-literal">admin</span> --clusterrole=cluster-<span class="hljs-literal">admin</span> --serviceaccount=kubernetes-dashboard:dashboard-<span class="hljs-literal">admin</span><br><span class="hljs-comment">#获取用户Token</span><br>kubectl create token dashboard-<span class="hljs-literal">admin</span> -n kubernetes-dashboard<br></code></pre></td></tr></table></figure>

<p><img src="/../img/OpenEuler-K8S%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%EF%BC%88%E5%86%85%E9%83%A8etcd%EF%BC%89/99a0dd24eed7831c3573591fe6ff1268697559838.png" srcset="/img/loading.gif" lazyload alt="image-20231111025817854"></p>
<p>记录token</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs smali">eyJhbGciOiJSUzI1NiIsImtpZCI6IjJxb21sRTZSckhEZ09FMnlvWU5IY3dfTTRIWDEzRUpsQ000MThhSWxYNDgifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiXSwiZXhwIjoxNjk5NjQ2Mjg3LCJpYXQiOjE2OTk2NDI2ODcsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJkYXNoYm9hcmQtYWRtaW4iLCJ1aWQiOiIyNTBhNTQ2MS03MGJlLTRhZTItOWY2Yi1hMDQwOWE1NWJhMTMifX0sIm5iZiI6MTY5OTY0MjY4Nywic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmVybmV0ZXMtZGFzaGJvYXJkOmRhc2hib2FyZC1hZG1pbiJ9.U-lH9_sRU4TVrpAznqS60INNSev9NxHu61igGUTzTBoaWo7WjPG7vzTnpZYhvsoglTzMEKhfranJkkkn95pe-prkvSasaAL6kXHw0jQjlSMzcYiF7DoLdkOtDJSukuALEubidf9eIwZXFZ-sezZdZHm4hnk5nWme5YtdOmYOJPh5sv1dzRvM1XuOHknJPTA1BbdZuVAtSGHSjkhwx-wl-41uuQoROW5GjJs0bz4zLBFn1w_pWaSMCn7pjGJNcbr6IuDV41km_etpwwxacWyfAcxNykzCtIiE1abJj7m-e944GvAn_eqxz3wCZD6Bgt41FWRzyMHjrppJfDjk7FaHNw<br><br></code></pre></td></tr></table></figure>

<h3 id="登录浏览器访问"><a href="#登录浏览器访问" class="headerlink" title="登录浏览器访问"></a>登录浏览器访问</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">https://192.168.48.200:30001<br><br><span class="hljs-section">输入token：</span><br><span class="hljs-section">----</span><br>eyJhbGciOiJSUzI1NiIsImtpZCI6IjJxb21sRTZSckhEZ09FMnlvWU5IY3dfTTRIWDEzRUpsQ000MThhSWxYNDgifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiXSwiZXhwIjoxNjk5NjQ2Mjg3LCJpYXQiOjE2OTk2NDI2ODcsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJkYXNoYm9hcmQtYWRtaW4iLCJ1aWQiOiIyNTBhNTQ2MS03MGJlLTRhZTItOWY2Yi1hMDQwOWE1NWJhMTMifX0sIm5iZiI6MTY5OTY0MjY4Nywic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmVybmV0ZXMtZGFzaGJvYXJkOmRhc2hib2FyZC1hZG1pbiJ9.U-lH9_sRU4TVrpAznqS60INNSev9NxHu61igGUTzTBoaWo7WjPG7vzTnpZYhvsoglTzMEKhfranJkkkn95pe-prkvSasaAL6kXHw0jQjlSMzcYiF7DoLdkOtDJSukuALEubidf9eIwZXFZ-sezZdZHm4hnk5nWme5YtdOmYOJPh5sv1dzRvM1XuOHknJPTA1BbdZuVAtSGHSjkhwx-wl-41uuQoROW5GjJs0bz4zLBFn1w_pWaSMCn7pjGJNcbr6IuDV41km_etpwwxacWyfAcxNykzCtIiE1abJj7m-e944GvAn_eqxz3wCZD6Bgt41FWRzyMHjrppJfDjk7FaHNw<br><br><span class="hljs-code">----</span><br><span class="hljs-code"></span><br></code></pre></td></tr></table></figure>

<p><img src="/../img/OpenEuler-K8S%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%EF%BC%88%E5%86%85%E9%83%A8etcd%EF%BC%89/310d86b1c1ca357d878ba2e8afd08704697559838.png" srcset="/img/loading.gif" lazyload alt="image-20231111025910110"></p>
<h3 id="部署一个nginx测试"><a href="#部署一个nginx测试" class="headerlink" title="部署一个nginx测试"></a>部署一个nginx测试</h3><p>操作节点[master1]</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">vim</span> <span class="hljs-string">web.yaml</span><br><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-comment">#apiVersion: extensions/v1beta1</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">web-deployment-label</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">web-deployment</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">web-selector</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">web-selector</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">web-container</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:latest</span><br>        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">Always</span><br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br>          <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">http</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">443</span><br>          <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">https</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">web-service-label</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">web-service</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">NodePort</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br>    <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">80</span><br>    <span class="hljs-attr">nodePort:</span> <span class="hljs-number">30080</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">https</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">443</span><br>    <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">443</span><br>    <span class="hljs-attr">nodePort:</span> <span class="hljs-number">30443</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">web-selector</span><br>    <br><span class="hljs-string">kubectl</span> <span class="hljs-string">apply</span> <span class="hljs-string">-f</span> <span class="hljs-string">web.yaml</span> <br></code></pre></td></tr></table></figure>

<p><img src="/../img/OpenEuler-K8S%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%EF%BC%88%E5%86%85%E9%83%A8etcd%EF%BC%89/ff6ee9e5448d6b6a05fac0b2a731090a697559838.png" srcset="/img/loading.gif" lazyload alt="image-20231014180923818"></p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs clean">### 查看nginx的pod 的详细信息<br>kubectl get deploy,svc,pod -o wide<br></code></pre></td></tr></table></figure>

<p><img src="/../img/OpenEuler-K8S%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%EF%BC%88%E5%86%85%E9%83%A8etcd%EF%BC%89/4a88a100ed55f1eaf7c93e2b0e1c6ce6697559838.png" srcset="/img/loading.gif" lazyload alt="image-20231016203536987"></p>
<p>访问nginx网站</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span><span class="hljs-number">192.168</span>.<span class="hljs-number">48.200</span>:<span class="hljs-number">30080</span><br></code></pre></td></tr></table></figure>

<p><img src="/../img/OpenEuler-K8S%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%EF%BC%88%E5%86%85%E9%83%A8etcd%EF%BC%89/fb7bb5c8e16a3dd999fe40a1803e9a02697559838.png" srcset="/img/loading.gif" lazyload alt="image-20231111030413487"></p>
<div class="tbsm" style="margin-top:54px;">
<div class="tbsm-top"><span><svg t="1674654360507" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="987" data-spm-anchor-id="a313x.7781069.0.i0" width="35" height="35"><path d="M410.49 97.74H155.08a56.74 56.74 0 0 0-56.84 56.73V410a56.84 56.84 0 0 0 56.84 56.84h255.41A56.83 56.83 0 0 0 467.32 410V154.58a56.83 56.83 0 0 0-56.83-56.84zM410.49 558.74H155.08a56.74 56.74 0 0 0-56.84 56.73V871a56.84 56.84 0 0 0 56.84 56.84h255.41A56.83 56.83 0 0 0 467.32 871V615.58a56.83 56.83 0 0 0-56.83-56.84zM871.49 558.74H616.08a56.74 56.74 0 0 0-56.84 56.73V871a56.84 56.84 0 0 0 56.84 56.84h255.41A56.83 56.83 0 0 0 928.32 871V615.58a56.83 56.83 0 0 0-56.83-56.84z" fill="#66EEFF" p-id="988"></path><path d="M410.49 558.74h-4.14A475 475 0 0 0 299.52 859.6a481.16 481.16 0 0 0 4.84 68.22h106.13A56.83 56.83 0 0 0 467.32 871V615.58a56.83 56.83 0 0 0-56.83-56.84zM871.49 558.74H616.08a56.74 56.74 0 0 0-56.84 56.73V871a56.84 56.84 0 0 0 56.84 56.84h255.41A56.83 56.83 0 0 0 928.32 871V615.58a56.83 56.83 0 0 0-56.83-56.84z" fill="#C2F8FF" p-id="989"></path></svg></span><span style="font-size:30px;"> 特别声明</span></div>
<div class="tbsm-wz">千屹博客旗下的所有文章，是通过本人课堂学习和课外自学所精心整理的知识巨著<br/>难免会有出错的地方<br/>如果细心的你发现了小失误，可以在下方评论区告诉我，或者私信我！<br />非常感谢大家的热烈支持！</div>
</div>
                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/K8s/">#K8s</a>
      
        <a href="/tags/OpenEuler/">#OpenEuler</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>OpenEuler-部署K8S高可用集群（内部etcd）</div>
      <div>https://blog.qianyios.top/2024/04/14/OpenEuler-K8S高可用集群（内部etcd）/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>严千屹</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年4月14日</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>更新于</div>
          <div>2024年4月15日</div>
        </div>
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
                <a target="_blank" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">
                  <span class="hint--top hint--rounded" aria-label="NC - 非商业性使用">
                    <i class="iconfont icon-nc"></i>
                  </span>
                </a>
              
                <a target="_blank" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">
                  <span class="hint--top hint--rounded" aria-label="ND - 禁止演绎">
                    <i class="iconfont icon-nd"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/04/30/Harbor%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E9%AB%98%E5%8F%AF%E7%94%A8/" title="Harbor共享存储高可用">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Harbor共享存储高可用</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/04/14/OpenEuler-%E9%83%A8%E7%BD%B2K8S%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%EF%BC%88%E5%A4%96%E9%83%A8etcd%EF%BC%89/" title="OpenEuler-部署K8S高可用集群（外部etcd）">
                        <span class="hidden-mobile">OpenEuler-部署K8S高可用集群（外部etcd）</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"geJAvpyCyYwmp1wI8u2CCkV5-gzGzoHsz","appKey":"WnNukDH4RUTtMsUwJvNG4vyR","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":true},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <div class="zsqk"> <p>(￣▽￣)" 赞赏！</p> <div class="zstb"> <a  class="qr-trigger" target="_self"> <i class="iconfont icon-wechat-fill" aria-hidden="true"></i> <img class="qr-img animate__animated animate__bounc animate__fadeInDown" src="https://blog.qianyios.top/img/zansang/wxzf.png" srcset="/img/loading.gif" lazyload alt="qrcode" /> </a> <a  class="qr-trigger" target="_self"> <i class="iconfont icon-alipay-fill" aria-hidden="true"></i> <img class="qr-img animate__animated animate__bounc animate__fadeInDown" src="https://blog.qianyios.top/img/zansang/zfb.png" srcset="/img/loading.gif" lazyload alt="qrcode" /> </a>
</div>
<p class="zsyy animate__animated animate__bounce animate__flash animate__infinite	infinite animate__slow">如果对你有帮助，就请我喝一杯吧！！</p> </div> <br /> <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
